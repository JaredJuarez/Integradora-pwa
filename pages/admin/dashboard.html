<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4F46E5">
    <title>Dashboard Administrador - PWA Sistema</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="../../manifest.json">
    <link rel="stylesheet" href="../../assets/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <div id="sidebarContainer"></div>

        <!-- Main content -->
        <div class="flex-1 flex flex-col">
            <!-- Header -->
            <div id="headerContainer"></div>

            <!-- Content -->
            <main class="flex-1 p-4 sm:p-6 lg:p-8">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Ventas Totales -->
                    <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Ventas Totales</p>
                                <p id="totalVentas" class="text-3xl font-bold text-gray-900 mt-2">$0</p>
                                <p class="text-green-600 text-sm mt-1">
                                    <i class="fas fa-arrow-up"></i> 12.5% vs mes anterior
                                </p>
                            </div>
                            <div class="bg-indigo-100 rounded-full p-4">
                                <i class="fas fa-dollar-sign text-3xl text-indigo-600"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Pedidos -->
                    <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Total Pedidos</p>
                                <p id="totalPedidos" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                                <p class="text-blue-600 text-sm mt-1">
                                    <i class="fas fa-clock"></i> <span id="pedidosPendientes">0</span> pendientes
                                </p>
                            </div>
                            <div class="bg-blue-100 rounded-full p-4">
                                <i class="fas fa-shopping-cart text-3xl text-blue-600"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Productos -->
                    <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Productos</p>
                                <p id="totalProductos" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                                <p class="text-yellow-600 text-sm mt-1">
                                    <i class="fas fa-exclamation-triangle"></i> <span id="productosBajoStock">0</span> bajo stock
                                </p>
                            </div>
                            <div class="bg-green-100 rounded-full p-4">
                                <i class="fas fa-box text-3xl text-green-600"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Usuarios -->
                    <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Usuarios</p>
                                <p id="totalUsuarios" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                                <p class="text-indigo-600 text-sm mt-1">
                                    <i class="fas fa-user-check"></i> <span id="clientesActivos">0</span> clientes activos
                                </p>
                            </div>
                            <div class="bg-purple-100 rounded-full p-4">
                                <i class="fas fa-users text-3xl text-purple-600"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <!-- Ventas por mes -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Ventas Mensuales</h3>
                        <canvas id="salesChart"></canvas>
                    </div>

                    <!-- Productos más vendidos -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Productos Más Vendidos</h3>
                        <canvas id="productsChart"></canvas>
                    </div>
                </div>

                <!-- Pedidos Recientes -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900">Pedidos Recientes</h3>
                            <a href="#" class="text-indigo-600 hover:text-indigo-500 text-sm font-medium">
                                Ver todos <i class="fas fa-arrow-right ml-1"></i>
                            </a>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Pedido
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Cliente
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Fecha
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Total
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Estado
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Acciones
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Pedidos cargados dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../../assets/js/utils.js"></script>
    <script src="../../assets/js/app.js"></script>
    <script src="../../assets/js/auth.js"></script>
    <script src="../../assets/js/data.js"></script>
    <script src="../../components/components.js"></script>
    <script>
        // Proteger página - solo administradores
        protectPage('administrador');

        // Cargar componentes
        document.getElementById('sidebarContainer').innerHTML = createAdminSidebar();
        document.getElementById('headerContainer').innerHTML = createHeader('Dashboard');

        // Cargar estadísticas
        function loadStats() {
            const stats = getDashboardStats();
            
            document.getElementById('totalVentas').textContent = Format.currency(stats.totalVentas);
            document.getElementById('totalPedidos').textContent = stats.totalPedidos;
            document.getElementById('pedidosPendientes').textContent = stats.pedidosPendientes;
            document.getElementById('totalProductos').textContent = stats.totalProductos;
            document.getElementById('productosBajoStock').textContent = stats.productosBajoStock;
            document.getElementById('totalUsuarios').textContent = stats.totalUsuarios;
            document.getElementById('clientesActivos').textContent = stats.clientesActivos;
        }

        // Gráfico de ventas mensuales
        function createSalesChart() {
            const ctx = document.getElementById('salesChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Ventas 2025',
                        data: [45000, 52000, 48000, 61000, 58000, 75000],
                        borderColor: 'rgb(79, 70, 229)',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // Gráfico de productos más vendidos
        function createProductsChart() {
            const ctx = document.getElementById('productsChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Laptop', 'iPhone', 'Samsung', 'iPad', 'Audífonos'],
                    datasets: [{
                        label: 'Unidades Vendidas',
                        data: [45, 62, 38, 29, 55],
                        backgroundColor: [
                            'rgba(79, 70, 229, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(249, 115, 22, 0.8)',
                            'rgba(236, 72, 153, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Cargar pedidos recientes
        function loadRecentOrders() {
            const orders = getOrders().slice(0, 5); // Últimos 5 pedidos
            const tbody = document.getElementById('ordersTableBody');
            
            if (orders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                            No hay pedidos recientes
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = orders.map(order => {
                const statusInfo = ORDER_STATUSES.find(s => s.value === order.estado);
                const badgeColor = statusInfo ? statusInfo.color : 'gray';
                
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            #${order.id}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${order.cliente}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${Format.date(order.fecha, 'short')}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
                            ${Format.currency(order.total)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="badge badge-${badgeColor === 'green' ? 'success' : badgeColor === 'red' ? 'danger' : badgeColor === 'yellow' ? 'warning' : 'primary'}">
                                ${statusInfo ? statusInfo.label : order.estado}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <button onclick="viewOrder(${order.id})" class="text-indigo-600 hover:text-indigo-900 mr-3">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function viewOrder(orderId) {
            const order = getOrderById(orderId);
            if (!order) return;
            
            const productsList = order.productos.map(p => 
                `<li>${p.nombre} - ${p.cantidad}x ${Format.currency(p.precio)}</li>`
            ).join('');
            
            showModal(
                `Pedido #${order.id}`,
                `
                    <div class="space-y-3">
                        <p><strong>Cliente:</strong> ${order.cliente}</p>
                        <p><strong>Fecha:</strong> ${Format.date(order.fecha)}</p>
                        <p><strong>Estado:</strong> <span class="badge badge-primary">${order.estado}</span></p>
                        <div>
                            <strong>Productos:</strong>
                            <ul class="list-disc pl-5 mt-2">${productsList}</ul>
                        </div>
                        <p><strong>Total:</strong> <span class="text-xl font-bold">${Format.currency(order.total)}</span></p>
                        <p><strong>Dirección:</strong> ${order.direccion}</p>
                    </div>
                `,
                [{ text: 'Cerrar', type: 'primary', onclick: 'closeModal()' }]
            );
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            createSalesChart();
            createProductsChart();
            loadRecentOrders();
        });

        window.viewOrder = viewOrder;
    </script>
</body>
</html>
