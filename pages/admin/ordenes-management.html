<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestión de Órdenes - Admin</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="manifest" href="../../manifest.json" />
    <link rel="stylesheet" href="../../assets/css/styles.css" />

    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCTJa-KaC0GQ055bZp9zc5kwa6acP-PDww"></script>

    <!-- Service Worker -->
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("../../sw.js")
            .then((reg) =>
              console.log("✅ Service Worker registrado:", reg.scope)
            )
            .catch((err) =>
              console.error("❌ Error al registrar Service Worker:", err)
            );
        });
      }
    </script>

    <style>
      #mapContainer {
        width: 100%;
        height: 400px;
        border-radius: 8px;
        overflow: hidden;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar -->
      <div id="sidebarContainer"></div>

      <!-- Main Content -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <div id="headerContainer"></div>

        <!-- Content -->
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
          <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="mb-6">
              <h2 class="text-2xl font-bold text-gray-900">
                Gestión de Órdenes
              </h2>
              <p class="text-gray-600 mt-1">
                Visualiza y administra las órdenes generadas
              </p>
            </div>

            <!-- Estadísticas -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
              <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                  <div
                    class="flex-shrink-0 bg-blue-100 rounded-full p-3 text-blue-600"
                  >
                    <i class="fas fa-clipboard-list text-2xl"></i>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm text-gray-500">Total Órdenes</p>
                    <p
                      id="totalOrders"
                      class="text-2xl font-bold text-gray-900"
                    >
                      0
                    </p>
                  </div>
                </div>
              </div>

              <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                  <div
                    class="flex-shrink-0 bg-green-100 rounded-full p-3 text-green-600"
                  >
                    <i class="fas fa-box text-2xl"></i>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm text-gray-500">Total Productos</p>
                    <p
                      id="totalProducts"
                      class="text-2xl font-bold text-gray-900"
                    >
                      0
                    </p>
                  </div>
                </div>
              </div>

              <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                  <div
                    class="flex-shrink-0 bg-purple-100 rounded-full p-3 text-purple-600"
                  >
                    <i class="fas fa-calendar-day text-2xl"></i>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm text-gray-500">Órdenes Hoy</p>
                    <p
                      id="ordersToday"
                      class="text-2xl font-bold text-gray-900"
                    >
                      0
                    </p>
                  </div>
                </div>
              </div>

              <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                  <div
                    class="flex-shrink-0 bg-orange-100 rounded-full p-3 text-orange-600"
                  >
                    <i class="fas fa-chart-line text-2xl"></i>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm text-gray-500">Cantidad Total</p>
                    <p
                      id="totalQuantity"
                      class="text-2xl font-bold text-gray-900"
                    >
                      0
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Filtros -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
              <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Buscar Orden</label
                  >
                  <input
                    type="text"
                    id="searchOrder"
                    placeholder="ID o producto..."
                    class="form-input w-full"
                  />
                </div>
                <div class="flex-1">
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Filtrar por Fecha</label
                  >
                  <input
                    type="date"
                    id="filterDate"
                    class="form-input w-full"
                  />
                </div>
                <div class="flex items-end">
                  <button
                    onclick="clearFilters()"
                    class="btn-secondary px-6 py-2.5"
                  >
                    <i class="fas fa-redo mr-2"></i> Limpiar
                  </button>
                </div>
              </div>
            </div>

            <!-- Lista de Órdenes -->
            <div class="bg-white rounded-lg shadow-md">
              <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">
                  Lista de Órdenes
                </h3>
              </div>

              <div id="ordersContainer" class="divide-y divide-gray-200">
                <!-- Se llenará dinámicamente -->
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Modal de Mapa -->
    <div
      id="mapModal"
      class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
    >
      <div
        class="relative top-20 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white"
      >
        <div class="flex justify-between items-center border-b pb-4 mb-4">
          <div>
            <h3 class="text-2xl font-bold text-gray-900">
              Ubicación de la Orden
            </h3>
            <p class="text-sm text-gray-600 mt-1" id="mapOrderInfo">Orden #0</p>
          </div>
          <button
            onclick="closeMapModal()"
            class="text-gray-400 hover:text-gray-600"
          >
            <i class="fas fa-times text-2xl"></i>
          </button>
        </div>

        <!-- Mapa -->
        <div id="mapContainer" class="mb-4"></div>

        <!-- Coordenadas -->
        <div class="bg-gray-50 p-4 rounded-lg mb-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <p class="text-sm text-gray-600">Latitud</p>
              <p class="font-medium text-gray-900" id="mapLatitude">-</p>
            </div>
            <div>
              <p class="text-sm text-gray-600">Longitud</p>
              <p class="font-medium text-gray-900" id="mapLongitude">-</p>
            </div>
          </div>
          <div class="mt-3">
            <a
              id="googleMapsLink"
              href="#"
              target="_blank"
              class="text-blue-600 hover:text-blue-800 text-sm"
            >
              <i class="fas fa-external-link-alt mr-2"></i>Abrir en Google Maps
            </a>
          </div>
        </div>

        <div class="flex justify-end">
          <button
            onclick="closeMapModal()"
            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
          >
            Cerrar
          </button>
        </div>
      </div>
    </div>

    <!-- Modal de Detalles -->
    <div
      id="detailsModal"
      class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
    >
      <div
        class="relative top-20 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white"
      >
        <div class="flex justify-between items-center border-b pb-4 mb-4">
          <h3 class="text-2xl font-bold text-gray-900">Detalles de la Orden</h3>
          <button
            onclick="closeDetailsModal()"
            class="text-gray-400 hover:text-gray-600"
          >
            <i class="fas fa-times text-2xl"></i>
          </button>
        </div>

        <div id="orderDetails" class="space-y-4">
          <!-- Se llenará dinámicamente -->
        </div>

        <div class="mt-6 flex justify-end">
          <button
            onclick="closeDetailsModal()"
            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
          >
            Cerrar
          </button>
        </div>
      </div>
    </div>

    <script src="../../assets/js/utils.js"></script>
    <script src="../../assets/js/API_BASE.js"></script>
    <script src="../../assets/js/order-api.js"></script>
    <script src="../../assets/js/auth.js"></script>
    <script src="../../assets/js/app.js"></script>
    <script src="../../components/components.js"></script>

    <script>
      // Variables globales
      const orderAPI = new OrderAPI();
      let allOrders = [];

      // Inicialización
      document.addEventListener("DOMContentLoaded", async () => {
        // Cargar UI primero
        loadSidebarAndHeader();

        // Verificar autenticación
        protectPage("administrador");

        await loadOrders();

        // Eventos
        document
          .getElementById("searchOrder")
          .addEventListener("input", filterOrders);
        document
          .getElementById("filterDate")
          .addEventListener("change", filterOrders);
      });

      function loadSidebarAndHeader() {
        document.getElementById("sidebarContainer").innerHTML =
          createAdminSidebar();
        document.getElementById("headerContainer").innerHTML =
          createHeader("Gestión de Órdenes");
      }

      async function loadOrders() {
        try {
          showLoader();
          allOrders = await orderAPI.getAllOrders();
          hideLoader();
          filterOrders();
          updateStats();
        } catch (error) {
          hideLoader();
          showNotification(
            "Error al cargar órdenes: " + error.message,
            "error"
          );
          console.error("Error:", error);
        }
      }

      function updateStats() {
        const totalOrders = allOrders.length;
        const totalProducts = allOrders.reduce(
          (sum, order) => sum + order.items.length,
          0
        );
        const totalQuantity = allOrders.reduce(
          (sum, order) =>
            sum + order.items.reduce((s, item) => s + item.cantidad, 0),
          0
        );

        // Órdenes de hoy
        const today = new Date().toISOString().split("T")[0];
        const ordersToday = allOrders.filter((order) =>
          order.fechaVisita.startsWith(today)
        ).length;

        document.getElementById("totalOrders").textContent = totalOrders;
        document.getElementById("totalProducts").textContent = totalProducts;
        document.getElementById("ordersToday").textContent = ordersToday;
        document.getElementById("totalQuantity").textContent = totalQuantity;
      }

      function filterOrders() {
        const searchTerm = document
          .getElementById("searchOrder")
          .value.toLowerCase();
        const filterDate = document.getElementById("filterDate").value;

        let orders = [...allOrders];

        // Filtrar por fecha
        if (filterDate) {
          orders = orders.filter((order) =>
            order.fechaVisita.startsWith(filterDate)
          );
        }

        // Filtrar por búsqueda
        if (searchTerm) {
          orders = orders.filter(
            (order) =>
              order.id.toString().includes(searchTerm) ||
              order.items.some((item) =>
                item.producto.nombre.toLowerCase().includes(searchTerm)
              )
          );
        }

        renderOrders(orders);
      }

      function renderOrders(orders) {
        const container = document.getElementById("ordersContainer");

        if (orders.length === 0) {
          container.innerHTML = `
            <div class="px-6 py-12 text-center text-gray-500">
              <i class="fas fa-clipboard-list text-5xl mb-4"></i>
              <p class="text-lg">No se encontraron órdenes</p>
            </div>
          `;
          return;
        }

        container.innerHTML = orders
          .map((order) => {
            const fecha = new Date(order.fechaVisita);
            const fechaFormateada = fecha.toLocaleString("es-MX", {
              year: "numeric",
              month: "long",
              day: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            });

            const totalItems = order.items.reduce(
              (sum, item) => sum + item.cantidad,
              0
            );

            return `
              <div class="p-6 hover:bg-gray-50 transition">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                  <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                      <span class="text-lg font-bold text-gray-900">Orden #${
                        order.id
                      }</span>
                      <span class="badge badge-primary">
                        <i class="fas fa-box mr-1"></i>
                        ${order.items.length} producto${
              order.items.length > 1 ? "s" : ""
            }
                      </span>
                      <span class="badge badge-secondary">
                        <i class="fas fa-cubes mr-1"></i>
                        ${totalItems} unidades
                      </span>
                    </div>
                    <p class="text-sm text-gray-600">
                      <i class="fas fa-calendar mr-2"></i>
                      ${fechaFormateada}
                    </p>
                    <div class="mt-2 flex flex-wrap gap-2">
                      ${order.items
                        .map(
                          (item) => `
                        <span class="text-xs bg-gray-100 px-2 py-1 rounded">
                          ${item.producto.nombre} (${item.cantidad})
                        </span>
                      `
                        )
                        .join("")}
                    </div>
                  </div>
                  <div class="flex gap-2">
                    <button
                      onclick="viewOrderDetails(${order.id})"
                      class="btn-secondary px-4 py-2"
                      title="Ver detalles"
                    >
                      <i class="fas fa-eye mr-2"></i>Ver Detalles
                    </button>
                    <button
                      onclick="viewOrderLocation(${order.id}, '${
              order.location
            }')"
                      class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition"
                      title="Ver ubicación"
                    >
                      <i class="fas fa-map-marker-alt"></i>
                    </button>
                    <button
                      onclick="deleteOrder(${order.id})"
                      class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition"
                      title="Eliminar"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            `;
          })
          .join("");
      }

      async function viewOrderDetails(orderId) {
        try {
          showLoader();
          const order = await orderAPI.getOrderById(orderId);
          hideLoader();

          const fecha = new Date(order.fechaVisita);
          const fechaFormateada = fecha.toLocaleString("es-MX", {
            year: "numeric",
            month: "long",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });

          const detailsHtml = `
            <div class="space-y-6">
              <!-- Información General -->
              <div class="bg-gray-50 p-4 rounded-lg">
                <h4 class="font-semibold text-gray-900 mb-3">Información General</h4>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <p class="text-sm text-gray-600">ID de Orden</p>
                    <p class="font-medium text-gray-900">#${order.id}</p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-600">Fecha de Visita</p>
                    <p class="font-medium text-gray-900">${fechaFormateada}</p>
                  </div>
                </div>
              </div>

              <!-- Foto de la Visita -->
              ${
                order.fotoUrl
                  ? `
                <div>
                  <h4 class="font-semibold text-gray-900 mb-3">Foto de la Visita</h4>
                  <div class="border rounded-lg overflow-hidden">
                    <img 
                      src="${order.fotoUrl}" 
                      alt="Foto de visita" 
                      class="w-full h-auto max-h-96 object-cover"
                      onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27400%27 height=%27300%27%3E%3Crect fill=%27%23f3f4f6%27 width=%27400%27 height=%27300%27/%3E%3Ctext fill=%27%239ca3af%27 font-family=%27sans-serif%27 font-size=%2718%27 dy=%2710.5%27 font-weight=%27bold%27 x=%2750%25%27 y=%2750%25%27 text-anchor=%27middle%27%3EImagen no disponible%3C/text%3E%3C/svg%3E'"
                    />
                  </div>
                </div>
              `
                  : ""
              }

              <!-- Lista de Productos -->
              <div>
                <h4 class="font-semibold text-gray-900 mb-3">Productos Ordenados</h4>
                <div class="border rounded-lg overflow-hidden">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                      <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Descripción</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Cantidad</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Estado</th>
                      </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                      ${order.items
                        .map(
                          (item) => `
                        <tr>
                          <td class="px-4 py-3 text-sm font-medium text-gray-900">
                            ${item.producto.nombre}
                          </td>
                          <td class="px-4 py-3 text-sm text-gray-600">
                            ${item.producto.descripcion || "Sin descripción"}
                          </td>
                          <td class="px-4 py-3 text-sm text-center">
                            <span class="badge badge-primary">${
                              item.cantidad
                            }</span>
                          </td>
                          <td class="px-4 py-3 text-center">
                            <span class="badge ${
                              item.producto.activo
                                ? "badge-success"
                                : "badge-danger"
                            }">
                              ${item.producto.activo ? "Activo" : "Inactivo"}
                            </span>
                          </td>
                        </tr>
                      `
                        )
                        .join("")}
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Resumen -->
              <div class="bg-blue-50 p-4 rounded-lg">
                <div class="flex justify-between items-center">
                  <span class="text-sm font-medium text-gray-700">Total de Productos:</span>
                  <span class="text-lg font-bold text-blue-600">${
                    order.items.length
                  }</span>
                </div>
                <div class="flex justify-between items-center mt-2">
                  <span class="text-sm font-medium text-gray-700">Cantidad Total:</span>
                  <span class="text-lg font-bold text-blue-600">
                    ${order.items.reduce(
                      (sum, item) => sum + item.cantidad,
                      0
                    )} unidades
                  </span>
                </div>
              </div>
            </div>
          `;

          document.getElementById("orderDetails").innerHTML = detailsHtml;
          document.getElementById("detailsModal").classList.remove("hidden");
        } catch (error) {
          hideLoader();
          showNotification(
            "Error al cargar detalles: " + error.message,
            "error"
          );
        }
      }

      function closeDetailsModal() {
        document.getElementById("detailsModal").classList.add("hidden");
      }

      async function deleteOrder(orderId) {
        if (
          !confirm(
            "¿Estás seguro de eliminar esta orden? Esta acción no se puede deshacer."
          )
        ) {
          return;
        }

        try {
          showLoader();
          await orderAPI.deleteOrder(orderId);
          hideLoader();

          showNotification("Orden eliminada correctamente", "success");
          await loadOrders();
        } catch (error) {
          hideLoader();
          showNotification(
            "Error al eliminar orden: " + error.message,
            "error"
          );
          console.error("Error:", error);
        }
      }

      function clearFilters() {
        document.getElementById("searchOrder").value = "";
        document.getElementById("filterDate").value = "";
        filterOrders();
      }

      // Funciones del mapa
      let map = null;
      let marker = null;

      function viewOrderLocation(orderId, location) {
        if (!location || location === "0,0") {
          showNotification(
            "Esta orden no tiene ubicación registrada",
            "warning"
          );
          return;
        }

        // Parsear coordenadas
        const [lat, lng] = location
          .split(",")
          .map((coord) => parseFloat(coord.trim()));

        if (isNaN(lat) || isNaN(lng)) {
          showNotification("Coordenadas inválidas", "error");
          return;
        }

        // Actualizar información del modal
        document.getElementById(
          "mapOrderInfo"
        ).textContent = `Orden #${orderId}`;
        document.getElementById("mapLatitude").textContent = lat.toFixed(6);
        document.getElementById("mapLongitude").textContent = lng.toFixed(6);
        document.getElementById(
          "googleMapsLink"
        ).href = `https://www.google.com/maps?q=${lat},${lng}`;

        // Mostrar modal
        document.getElementById("mapModal").classList.remove("hidden");

        // Esperar a que el modal sea visible antes de inicializar el mapa
        setTimeout(() => {
          initMap(lat, lng);
        }, 100);
      }

      function initMap(lat, lng) {
        const position = { lat, lng };

        // Crear mapa
        map = new google.maps.Map(document.getElementById("mapContainer"), {
          center: position,
          zoom: 15,
          mapTypeId: google.maps.MapTypeId.ROADMAP,
        });

        // Agregar marcador
        marker = new google.maps.Marker({
          position: position,
          map: map,
          title: "Ubicación de la orden",
          animation: google.maps.Animation.DROP,
        });

        // InfoWindow con información
        const infoWindow = new google.maps.InfoWindow({
          content: `
            <div class="p-2">
              <h3 class="font-bold text-gray-900 mb-1">Ubicación de la Orden</h3>
              <p class="text-sm text-gray-600">Lat: ${lat.toFixed(6)}</p>
              <p class="text-sm text-gray-600">Lng: ${lng.toFixed(6)}</p>
            </div>
          `,
        });

        // Mostrar info al hacer clic en el marcador
        marker.addListener("click", () => {
          infoWindow.open(map, marker);
        });

        // Abrir info por defecto
        infoWindow.open(map, marker);
      }

      function closeMapModal() {
        document.getElementById("mapModal").classList.add("hidden");

        // Limpiar mapa
        if (map) {
          map = null;
          marker = null;
        }
      }

      // Cerrar modal al hacer clic fuera
      document.getElementById("mapModal").addEventListener("click", (e) => {
        if (e.target.id === "mapModal") {
          closeMapModal();
        }
      });

      document.getElementById("detailsModal").addEventListener("click", (e) => {
        if (e.target.id === "detailsModal") {
          closeDetailsModal();
        }
      });
    </script>
  </body>
</html>
