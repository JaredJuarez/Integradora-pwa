<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestión de Tiendas - Admin</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="manifest" href="../../manifest.json" />
    <link rel="stylesheet" href="../../assets/css/styles.css" />
  </head>
  <body class="bg-gray-100">
    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar -->
      <div id="sidebarContainer"></div>

      <!-- Main Content -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <div id="headerContainer"></div>

        <!-- Content -->
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
          <div class="max-w-7xl mx-auto">
            <!-- Page Header -->
            <div class="mb-6 flex justify-between items-center">
              <div>
                <h1 class="text-3xl font-bold text-gray-900">
                  Gestión de Tiendas
                </h1>
                <p class="text-gray-600 mt-1">
                  Administra las tiendas y asigna empleados
                </p>
              </div>
              <button
                onclick="openStoreModal()"
                class="btn-primary flex items-center"
              >
                <i class="fas fa-plus mr-2"></i>
                Nueva Tienda
              </button>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
              <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                  <div class="p-3 rounded-full bg-gray-100 text-gray-700">
                    <i class="fas fa-store text-2xl"></i>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm text-gray-600">Total Tiendas</p>
                    <p id="totalStores" class="text-2xl font-bold">0</p>
                  </div>
                </div>
              </div>

              <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                  <div class="p-3 rounded-full bg-green-100 text-green-700">
                    <i class="fas fa-check-circle text-2xl"></i>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm text-gray-600">Con Empleado</p>
                    <p id="assignedStores" class="text-2xl font-bold">0</p>
                  </div>
                </div>
              </div>

              <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                  <div class="p-3 rounded-full bg-yellow-100 text-yellow-700">
                    <i class="fas fa-exclamation-triangle text-2xl"></i>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm text-gray-600">Sin Empleado</p>
                    <p id="unassignedStores" class="text-2xl font-bold">0</p>
                  </div>
                </div>
              </div>

              <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                  <div class="p-3 rounded-full bg-blue-100 text-blue-700">
                    <i class="fas fa-calendar-alt text-2xl"></i>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm text-gray-600">Visitas Hoy</p>
                    <p id="visitsTodayCount" class="text-2xl font-bold">0</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Stores Table -->
            <div class="bg-white rounded-lg shadow">
              <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                  <h2 class="text-xl font-semibold text-gray-900">
                    Lista de Tiendas
                  </h2>
                  <div class="flex space-x-2">
                    <input
                      type="text"
                      id="searchStore"
                      placeholder="Buscar tienda..."
                      class="form-input w-64"
                    />
                    <select id="filterEmployee" class="form-input w-48">
                      <option value="">Todos los empleados</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-gray-50">
                    <tr>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        ID
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Nombre
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Dirección
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Frecuencia
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Última Visita
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Próxima Visita
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Empleado
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Acciones
                      </th>
                    </tr>
                  </thead>
                  <tbody
                    id="storesTableBody"
                    class="bg-white divide-y divide-gray-200"
                  >
                    <!-- Se llenará dinámicamente -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Modal Tienda -->
    <div
      id="storeModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
    >
      <div
        class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto"
      >
        <div class="p-6 border-b border-gray-200">
          <div class="flex justify-between items-center">
            <h3 id="modalTitle" class="text-2xl font-bold text-gray-900">
              Nueva Tienda
            </h3>
            <button
              onclick="closeStoreModal()"
              class="text-gray-400 hover:text-gray-600"
            >
              <i class="fas fa-times text-2xl"></i>
            </button>
          </div>
        </div>

        <form id="storeForm" class="p-6">
          <input type="hidden" id="storeId" />

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Nombre de la Tienda *</label
              >
              <input
                type="text"
                id="storeName"
                required
                class="form-input"
                placeholder="Ej: Tienda Centro"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Dirección Completa *</label
              >
              <textarea
                id="storeAddress"
                required
                rows="2"
                class="form-input"
                placeholder="Av. Principal #123, Col. Centro, CP 12345"
              ></textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Frecuencia de Visita (días) *</label
                >
                <input
                  type="number"
                  id="storeFrequency"
                  required
                  min="1"
                  max="30"
                  class="form-input"
                  placeholder="Ej: 3"
                />
                <small class="text-gray-500 text-xs"
                  >Cada cuántos días se debe visitar la tienda</small
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Empleado Asignado</label
                >
                <select id="storeEmployee" class="form-input">
                  <option value="">Sin asignar</option>
                </select>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Estado</label
              >
              <select id="storeActive" class="form-input">
                <option value="true">Activa</option>
                <option value="false">Inactiva</option>
              </select>
            </div>
          </div>

          <div class="mt-6 flex justify-end space-x-3">
            <button
              type="button"
              onclick="closeStoreModal()"
              class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
            >
              Cancelar
            </button>
            <button type="submit" class="btn-primary">
              <i class="fas fa-save mr-2"></i>
              Guardar
            </button>
          </div>
        </form>
      </div>
    </div>

    <script src="../../assets/js/utils.js"></script>
    <script src="../../assets/js/auth.js"></script>
    <script src="../../assets/js/app.js"></script>
    <script src="../../assets/js/admin-data.js"></script>
    <script src="../../components/components.js"></script>

    <script>
      // Verificar autenticación
      checkAuth(["admin"]);

      // Variables globales
      let editingStoreId = null;

      // Inicializar página
      document.addEventListener("DOMContentLoaded", () => {
        loadSidebarAndHeader();
        loadStores();
        loadStats();
        loadEmployeeFilters();

        // Eventos
        document
          .getElementById("searchStore")
          .addEventListener("input", filterStores);
        document
          .getElementById("filterEmployee")
          .addEventListener("change", filterStores);
        document
          .getElementById("storeForm")
          .addEventListener("submit", handleStoreSubmit);
      });

      function loadSidebarAndHeader() {
        document.getElementById("sidebarContainer").innerHTML =
          createAdminSidebar();
        document.getElementById("headerContainer").innerHTML =
          createAdminHeader();
      }

      function loadEmployeeFilters() {
        const employees = adminDataManager
          .getAllEmployees()
          .filter((emp) => emp.activo);
        const filterSelect = document.getElementById("filterEmployee");
        const employeeSelect = document.getElementById("storeEmployee");

        // Cargar filtro
        filterSelect.innerHTML =
          '<option value="">Todos los empleados</option>' +
          employees
            .map((emp) => `<option value="${emp.id}">${emp.nombre}</option>`)
            .join("");

        // Cargar select de asignación
        employeeSelect.innerHTML =
          '<option value="">Sin asignar</option>' +
          employees
            .map((emp) => `<option value="${emp.id}">${emp.nombre}</option>`)
            .join("");
      }

      function loadStores() {
        const stores = adminDataManager.getAllStores();
        const tbody = document.getElementById("storesTableBody");

        if (stores.length === 0) {
          tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-store text-4xl mb-2"></i>
                            <p>No hay tiendas registradas</p>
                        </td>
                    </tr>
                `;
          return;
        }

        tbody.innerHTML = stores
          .map((store) => {
            const employee = store.empleadoAsignado
              ? adminDataManager.getEmployeeById(store.empleadoAsignado)
              : null;
            const nextVisit = adminDataManager.getNextVisitDate(store);
            const shouldVisit = adminDataManager.shouldVisitToday(store);

            return `
                    <tr class="hover:bg-gray-50 ${
                      shouldVisit ? "bg-yellow-50" : ""
                    }">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${
                          store.id
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <i class="fas fa-store text-gray-700 mr-3"></i>
                                <div class="text-sm font-medium text-gray-900">${
                                  store.nombre
                                }</div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">${
                          store.direccion
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            Cada ${store.frecuenciaVisita} día${
              store.frecuenciaVisita > 1 ? "s" : ""
            }
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${
                              store.ultimaVisita
                                ? formatDate(store.ultimaVisita)
                                : '<span class="text-yellow-600">Sin visitas</span>'
                            }
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            ${
                              nextVisit
                                ? `<span class="${
                                    shouldVisit
                                      ? "text-red-600 font-bold"
                                      : "text-gray-500"
                                  }">${formatDate(
                                    nextVisit.toISOString().split("T")[0]
                                  )}</span>`
                                : '<span class="text-yellow-600 font-bold">Pendiente</span>'
                            }
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            ${
                              employee
                                ? `<span class="badge badge-primary">${employee.nombre}</span>`
                                : '<span class="badge badge-warning">Sin asignar</span>'
                            }
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            <button onclick="editStore('${
                              store.id
                            }')" class="text-gray-600 hover:text-gray-900" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="assignEmployee('${
                              store.id
                            }')" class="text-blue-600 hover:text-blue-900" title="Asignar empleado">
                                <i class="fas fa-user-plus"></i>
                            </button>
                            <button onclick="deleteStore('${
                              store.id
                            }')" class="text-red-600 hover:text-red-900" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
          })
          .join("");
      }

      function loadStats() {
        const stores = adminDataManager.getAllStores();
        const activeStores = stores.filter((s) => s.activa);
        const assigned = activeStores.filter((s) => s.empleadoAsignado).length;
        const unassigned = activeStores.filter(
          (s) => !s.empleadoAsignado
        ).length;

        // Contar visitas de hoy
        let visitsToday = 0;
        const employees = adminDataManager.getAllEmployees();
        employees.forEach((emp) => {
          const storesToVisit = adminDataManager.getStoresToVisitToday(emp.id);
          visitsToday += storesToVisit.length;
        });

        document.getElementById("totalStores").textContent =
          activeStores.length;
        document.getElementById("assignedStores").textContent = assigned;
        document.getElementById("unassignedStores").textContent = unassigned;
        document.getElementById("visitsTodayCount").textContent = visitsToday;
      }

      function filterStores() {
        const searchTerm = document
          .getElementById("searchStore")
          .value.toLowerCase();
        const employeeFilter = document.getElementById("filterEmployee").value;

        let stores = adminDataManager.getAllStores();

        // Filtrar por empleado
        if (employeeFilter) {
          stores = stores.filter(
            (store) => store.empleadoAsignado === employeeFilter
          );
        }

        // Filtrar por búsqueda
        if (searchTerm) {
          stores = stores.filter(
            (store) =>
              store.nombre.toLowerCase().includes(searchTerm) ||
              store.direccion.toLowerCase().includes(searchTerm) ||
              store.id.toLowerCase().includes(searchTerm)
          );
        }

        const tbody = document.getElementById("storesTableBody");

        if (stores.length === 0) {
          tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-search text-4xl mb-2"></i>
                            <p>No se encontraron tiendas</p>
                        </td>
                    </tr>
                `;
          return;
        }

        tbody.innerHTML = stores
          .map((store) => {
            const employee = store.empleadoAsignado
              ? adminDataManager.getEmployeeById(store.empleadoAsignado)
              : null;
            const nextVisit = adminDataManager.getNextVisitDate(store);
            const shouldVisit = adminDataManager.shouldVisitToday(store);

            return `
                    <tr class="hover:bg-gray-50 ${
                      shouldVisit ? "bg-yellow-50" : ""
                    }">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${
                          store.id
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <i class="fas fa-store text-gray-700 mr-3"></i>
                                <div class="text-sm font-medium text-gray-900">${
                                  store.nombre
                                }</div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">${
                          store.direccion
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            Cada ${store.frecuenciaVisita} día${
              store.frecuenciaVisita > 1 ? "s" : ""
            }
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${
                              store.ultimaVisita
                                ? formatDate(store.ultimaVisita)
                                : '<span class="text-yellow-600">Sin visitas</span>'
                            }
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            ${
                              nextVisit
                                ? `<span class="${
                                    shouldVisit
                                      ? "text-red-600 font-bold"
                                      : "text-gray-500"
                                  }">${formatDate(
                                    nextVisit.toISOString().split("T")[0]
                                  )}</span>`
                                : '<span class="text-yellow-600 font-bold">Pendiente</span>'
                            }
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            ${
                              employee
                                ? `<span class="badge badge-primary">${employee.nombre}</span>`
                                : '<span class="badge badge-warning">Sin asignar</span>'
                            }
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            <button onclick="editStore('${
                              store.id
                            }')" class="text-gray-600 hover:text-gray-900">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="assignEmployee('${
                              store.id
                            }')" class="text-blue-600 hover:text-blue-900">
                                <i class="fas fa-user-plus"></i>
                            </button>
                            <button onclick="deleteStore('${
                              store.id
                            }')" class="text-red-600 hover:text-red-900">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
          })
          .join("");
      }

      function openStoreModal(id = null) {
        editingStoreId = id;
        const modal = document.getElementById("storeModal");
        const form = document.getElementById("storeForm");
        const title = document.getElementById("modalTitle");

        form.reset();
        loadEmployeeFilters();

        if (id) {
          title.textContent = "Editar Tienda";
          const store = adminDataManager.getStoreById(id);

          if (store) {
            document.getElementById("storeId").value = store.id;
            document.getElementById("storeName").value = store.nombre;
            document.getElementById("storeAddress").value = store.direccion;
            document.getElementById("storeFrequency").value =
              store.frecuenciaVisita;
            document.getElementById("storeEmployee").value =
              store.empleadoAsignado || "";
            document.getElementById("storeActive").value =
              store.activa.toString();
          }
        } else {
          title.textContent = "Nueva Tienda";
        }

        modal.classList.remove("hidden");
      }

      function closeStoreModal() {
        document.getElementById("storeModal").classList.add("hidden");
        editingStoreId = null;
      }

      function handleStoreSubmit(e) {
        e.preventDefault();

        const storeData = {
          nombre: document.getElementById("storeName").value.trim(),
          direccion: document.getElementById("storeAddress").value.trim(),
          frecuenciaVisita: parseInt(
            document.getElementById("storeFrequency").value
          ),
          empleadoAsignado:
            document.getElementById("storeEmployee").value || null,
          activa: document.getElementById("storeActive").value === "true",
        };

        try {
          if (editingStoreId) {
            adminDataManager.updateStore(editingStoreId, storeData);
            showNotification("Tienda actualizada exitosamente", "success");
          } else {
            adminDataManager.createStore(storeData);
            showNotification("Tienda creada exitosamente", "success");
          }

          closeStoreModal();
          loadStores();
          loadStats();
        } catch (error) {
          showNotification("Error al guardar la tienda", "error");
          console.error(error);
        }
      }

      function editStore(id) {
        openStoreModal(id);
      }

      function assignEmployee(storeId) {
        const store = adminDataManager.getStoreById(storeId);
        if (!store) return;

        openStoreModal(storeId);
      }

      function deleteStore(id) {
        if (confirm("¿Estás seguro de eliminar esta tienda?")) {
          try {
            adminDataManager.deleteStore(id);
            showNotification("Tienda eliminada exitosamente", "success");
            loadStores();
            loadStats();
          } catch (error) {
            showNotification("Error al eliminar la tienda", "error");
            console.error(error);
          }
        }
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("es-MX", {
          year: "numeric",
          month: "short",
          day: "numeric",
        });
      }
    </script>
  </body>
</html>
