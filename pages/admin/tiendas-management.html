<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestión de Tiendas - Admin</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="manifest" href="../../manifest.json" />
    <link rel="stylesheet" href="../../assets/css/styles.css" />

    <!-- Service Worker -->
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("../../sw.js")
            .then((reg) =>
              console.log("✅ Service Worker registrado:", reg.scope)
            )
            .catch((err) =>
              console.error("❌ Error al registrar Service Worker:", err)
            );
        });
      }
    </script>
  </head>
  <body class="bg-gray-100">
    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar -->
      <div id="sidebarContainer"></div>

      <!-- Main Content -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <div id="headerContainer"></div>

        <!-- Content -->
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
          <div class="max-w-7xl mx-auto">
            <!-- Page Header -->
            <div class="mb-6 flex justify-between items-center">
              <div>
                <h1 class="text-3xl font-bold text-gray-900">
                  Gestión de Tiendas
                </h1>
                <p class="text-gray-600 mt-1">
                  Administra las tiendas y asigna empleados
                </p>
              </div>
              <button
                onclick="openStoreModal()"
                class="btn-primary flex items-center"
              >
                <i class="fas fa-plus mr-2"></i>
                Nueva Tienda
              </button>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
              <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                  <div class="p-3 rounded-full bg-gray-100 text-gray-700">
                    <i class="fas fa-store text-2xl"></i>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm text-gray-600">Total Tiendas</p>
                    <p id="totalStores" class="text-2xl font-bold">0</p>
                  </div>
                </div>
              </div>

              <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                  <div class="p-3 rounded-full bg-green-100 text-green-700">
                    <i class="fas fa-check-circle text-2xl"></i>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm text-gray-600">Con Empleado</p>
                    <p id="assignedStores" class="text-2xl font-bold">0</p>
                  </div>
                </div>
              </div>

              <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                  <div class="p-3 rounded-full bg-yellow-100 text-yellow-700">
                    <i class="fas fa-exclamation-triangle text-2xl"></i>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm text-gray-600">Sin Empleado</p>
                    <p id="unassignedStores" class="text-2xl font-bold">0</p>
                  </div>
                </div>
              </div>

              <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                  <div class="p-3 rounded-full bg-blue-100 text-blue-700">
                    <i class="fas fa-calendar-alt text-2xl"></i>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm text-gray-600">Visitas Hoy</p>
                    <p id="visitsTodayCount" class="text-2xl font-bold">0</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Stores Table -->
            <div class="bg-white rounded-lg shadow">
              <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                  <h2 class="text-xl font-semibold text-gray-900">
                    Lista de Tiendas
                  </h2>
                  <div class="flex space-x-2">
                    <input
                      type="text"
                      id="searchStore"
                      placeholder="Buscar tienda..."
                      class="form-input w-64"
                    />
                    <select id="filterEmployee" class="form-input w-48">
                      <option value="">Todos los empleados</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-gray-50">
                    <tr>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        ID
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Nombre
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Dirección
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Frecuencia
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Empleado
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Última Visita
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Acciones
                      </th>
                    </tr>
                  </thead>
                  <tbody
                    id="storesTableBody"
                    class="bg-white divide-y divide-gray-200"
                  >
                    <!-- Se llenará dinámicamente -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Modal Tienda -->
    <div
      id="storeModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
    >
      <div
        class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto"
      >
        <div class="p-6 border-b border-gray-200">
          <div class="flex justify-between items-center">
            <h3 id="modalTitle" class="text-2xl font-bold text-gray-900">
              Nueva Tienda
            </h3>
            <button
              onclick="closeStoreModal()"
              class="text-gray-400 hover:text-gray-600"
            >
              <i class="fas fa-times text-2xl"></i>
            </button>
          </div>
        </div>

        <form id="storeForm" class="p-6">
          <input type="hidden" id="storeId" />

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Nombre de la Tienda *</label
              >
              <input
                type="text"
                id="storeName"
                required
                class="form-input"
                placeholder="Ej: Tienda Centro"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Dirección Completa *</label
              >
              <textarea
                id="storeAddress"
                required
                rows="2"
                class="form-input"
                placeholder="Av. Principal #123, Col. Centro, CP 12345"
              ></textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Frecuencia de Visita (días) *</label
                >
                <input
                  type="number"
                  id="storeFrequency"
                  required
                  min="1"
                  max="30"
                  class="form-input"
                  placeholder="Ej: 3"
                />
                <small class="text-gray-500 text-xs"
                  >Cada cuántos días se debe visitar la tienda</small
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Empleado Asignado *</label
                >
                <select id="storeEmployee" class="form-input" required>
                  <option value="">Seleccione un empleado</option>
                </select>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Estado</label
              >
              <select id="storeActive" class="form-input">
                <option value="true">Activa</option>
                <option value="false">Inactiva</option>
              </select>
            </div>
          </div>

          <div class="mt-6 flex justify-end space-x-3">
            <button
              type="button"
              onclick="closeStoreModal()"
              class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
            >
              Cancelar
            </button>
            <button type="submit" class="btn-primary">
              <i class="fas fa-save mr-2"></i>
              Guardar
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal QR Code -->
    <div
      id="qrModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
    >
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="p-6 border-b border-gray-200">
          <div class="flex justify-between items-center">
            <h3 class="text-2xl font-bold text-gray-900">
              Código QR de Tienda
            </h3>
            <button
              onclick="closeQRModal()"
              class="text-gray-400 hover:text-gray-600"
            >
              <i class="fas fa-times text-2xl"></i>
            </button>
          </div>
        </div>

        <div class="p-6">
          <div class="text-center">
            <h4
              id="qrStoreName"
              class="text-lg font-semibold text-gray-900 mb-2"
            ></h4>
            <p class="text-sm text-gray-600 mb-6">
              ID: <span id="qrStoreId"></span>
            </p>

            <!-- Contenedor del QR -->
            <div class="flex justify-center mb-6">
              <div
                id="qrCodeContainer"
                class="inline-block p-4 bg-white border-2 border-gray-200 rounded-lg"
              ></div>
            </div>

            <!-- Botones de acción -->
            <div class="flex space-x-3">
              <button onclick="downloadQR()" class="flex-1 btn-primary">
                <i class="fas fa-download mr-2"></i>
                Descargar QR
              </button>
              <button
                onclick="printQR()"
                class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md"
              >
                <i class="fas fa-print mr-2"></i>
                Imprimir
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Librería QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script src="../../assets/js/utils.js"></script>
    <script src="../../assets/js/API_BASE.js"></script>
    <script src="../../assets/js/store-api.js"></script>
    <script src="../../assets/js/employee-api.js"></script>
    <script src="../../assets/js/auth.js"></script>
    <script src="../../assets/js/app.js"></script>
    <script src="../../components/components.js"></script>

    <script>
      // Variables globales
      let editingStoreId = null;
      let allStores = [];
      let allEmployees = [];

      // Inicializar página
      document.addEventListener("DOMContentLoaded", async () => {
        // Cargar UI primero
        loadSidebarAndHeader();

        // Verificar autenticación
        protectPage("administrador");

        await loadEmployees();
        await loadStores();
        await loadStats();

        // Eventos
        document
          .getElementById("searchStore")
          .addEventListener("input", filterStores);
        document
          .getElementById("filterEmployee")
          .addEventListener("change", filterStores);
        document
          .getElementById("storeForm")
          .addEventListener("submit", handleStoreSubmit);
      });

      function loadSidebarAndHeader() {
        document.getElementById("sidebarContainer").innerHTML =
          createAdminSidebar();
        document.getElementById("headerContainer").innerHTML =
          createHeader("Gestión de Tiendas");
      }

      async function loadEmployees() {
        try {
          allEmployees = await employeeAPI.getAllEmployees();
          const activeEmployees = allEmployees.filter((emp) => emp.activo);
          const filterSelect = document.getElementById("filterEmployee");
          const employeeSelect = document.getElementById("storeEmployee");

          // Cargar filtro
          filterSelect.innerHTML =
            '<option value="">Todos los empleados</option>' +
            activeEmployees
              .map((emp) => `<option value="${emp.id}">${emp.nombre}</option>`)
              .join("");

          // Cargar select de asignación
          employeeSelect.innerHTML =
            '<option value="">Sin asignar</option>' +
            activeEmployees
              .map((emp) => `<option value="${emp.id}">${emp.nombre}</option>`)
              .join("");
        } catch (error) {
          console.error("Error al cargar empleados:", error);
        }
      }

      async function loadStores() {
        try {
          showLoader();
          allStores = await storeAPI.getAllStores();
          hideLoader();
          filterStores();
        } catch (error) {
          hideLoader();
          showNotification(
            "Error al cargar tiendas: " + error.message,
            "error"
          );
          console.error("Error:", error);
        }
      }

      async function loadStats() {
        try {
          const stores = allStores.filter((s) => s.activa);
          const assigned = stores.filter((s) => s.empleadoAsignado).length;
          const unassigned = stores.filter((s) => !s.empleadoAsignado).length;

          document.getElementById("totalStores").textContent = stores.length;
          document.getElementById("assignedStores").textContent = assigned;
          document.getElementById("unassignedStores").textContent = unassigned;
          document.getElementById("visitsTodayCount").textContent = 0; // Por ahora en 0
        } catch (error) {
          console.error("Error al cargar estadísticas:", error);
        }
      }

      function filterStores() {
        const searchTerm = document
          .getElementById("searchStore")
          .value.toLowerCase();
        const employeeFilter = document.getElementById("filterEmployee").value;

        let stores = [...allStores];

        // Filtrar por empleado
        if (employeeFilter) {
          stores = stores.filter(
            (store) =>
              store.empleadoAsignado &&
              store.empleadoAsignado.toString() === employeeFilter
          );
        }

        // Filtrar por búsqueda
        if (searchTerm) {
          stores = stores.filter(
            (store) =>
              store.nombre.toLowerCase().includes(searchTerm) ||
              store.direccion.toLowerCase().includes(searchTerm) ||
              store.id.toString().includes(searchTerm)
          );
        }

        const tbody = document.getElementById("storesTableBody");

        if (stores.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                <i class="fas fa-search text-4xl mb-2"></i>
                <p>No se encontraron tiendas</p>
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = stores
          .map((store) => {
            const employee = store.empleadoAsignado
              ? allEmployees.find((emp) => emp.id === store.empleadoAsignado)
              : null;

            return `
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${
                  store.id
                }</td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <i class="fas fa-store text-gray-700 mr-3"></i>
                    <div class="text-sm font-medium text-gray-900">${
                      store.nombre
                    }</div>
                  </div>
                </td>
                <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">${
                  store.direccion
                }</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  Cada ${store.frecuenciaVisita} día${
              store.frecuenciaVisita > 1 ? "s" : ""
            }
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                  ${
                    store.empleadoAsignado
                      ? `<span class="badge badge-primary">${
                          store.empleadoNombre ||
                          (employee ? employee.nombre : "Empleado")
                        }</span>`
                      : '<span class="badge badge-warning">Sin asignar</span>'
                  }
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                  ${
                    store.lastVisitDate
                      ? new Date(store.lastVisitDate).toLocaleDateString(
                          "es-ES"
                        )
                      : '<span class="text-gray-400">Sin visitas</span>'
                  }
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                  <button onclick="generateQR(${
                    store.id
                  })" class="text-blue-600 hover:text-blue-900" title="Generar QR">
                    <i class="fas fa-qrcode"></i>
                  </button>
                  <button onclick="editStore(${
                    store.id
                  })" class="text-gray-600 hover:text-gray-900" title="Editar">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button onclick="deleteStore(${
                    store.id
                  })" class="text-red-600 hover:text-red-900" title="Eliminar">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            `;
          })
          .join("");
      }

      async function openStoreModal(id = null) {
        editingStoreId = id;
        const modal = document.getElementById("storeModal");
        const form = document.getElementById("storeForm");
        const title = document.getElementById("modalTitle");

        form.reset();

        if (id) {
          title.textContent = "Editar Tienda";
          try {
            showLoader();
            const store = await storeAPI.getStoreById(id);
            hideLoader();

            document.getElementById("storeId").value = store.id;
            document.getElementById("storeName").value = store.nombre;
            document.getElementById("storeAddress").value = store.direccion;
            document.getElementById("storeFrequency").value =
              store.frecuenciaVisita;
            document.getElementById("storeEmployee").value =
              store.empleadoAsignado || "";
            document.getElementById("storeActive").value =
              store.activa.toString();
          } catch (error) {
            hideLoader();
            showNotification(
              "Error al cargar tienda: " + error.message,
              "error"
            );
            return;
          }
        } else {
          title.textContent = "Nueva Tienda";
        }

        modal.classList.remove("hidden");
      }

      function closeStoreModal() {
        document.getElementById("storeModal").classList.add("hidden");
        editingStoreId = null;
      }

      async function handleStoreSubmit(e) {
        e.preventDefault();

        const storeData = {
          nombre: document.getElementById("storeName").value.trim(),
          direccion: document.getElementById("storeAddress").value.trim(),
          frecuenciaVisita: parseInt(
            document.getElementById("storeFrequency").value
          ),
          empleadoAsignado:
            document.getElementById("storeEmployee").value || null,
          activa: document.getElementById("storeActive").value === "true",
        };

        try {
          showLoader();
          if (editingStoreId) {
            await storeAPI.updateStore(editingStoreId, storeData);
            showNotification("Tienda actualizada exitosamente", "success");
          } else {
            await storeAPI.createStore(storeData);
            showNotification("Tienda creada exitosamente", "success");
          }
          hideLoader();

          closeStoreModal();
          await loadStores();
          await loadStats();
        } catch (error) {
          hideLoader();
          showNotification(
            "Error al guardar la tienda: " + error.message,
            "error"
          );
          console.error(error);
        }
      }

      async function editStore(id) {
        await openStoreModal(id);
      }

      async function deleteStore(id) {
        const store = allStores.find((s) => s.id === id);
        if (!store) return;

        if (confirm(`¿Estás seguro de eliminar "${store.nombre}"?`)) {
          try {
            showLoader();
            await storeAPI.deleteStore(id);
            hideLoader();
            showNotification("Tienda eliminada exitosamente", "success");
            await loadStores();
            await loadStats();
          } catch (error) {
            hideLoader();
            showNotification(
              "Error al eliminar la tienda: " + error.message,
              "error"
            );
            console.error(error);
          }
        }
      }

      window.editStore = editStore;
      window.deleteStore = deleteStore;
      window.openStoreModal = openStoreModal;
      window.closeStoreModal = closeStoreModal;

      // ===== FUNCIONES PARA QR CODE =====
      let currentQRCode = null;
      let currentStoreForQR = null;

      /**
       * Genera y muestra el código QR para una tienda
       */
      function generateQR(storeId) {
        const store = allStores.find((s) => s.id === storeId);
        if (!store) {
          showNotification("Tienda no encontrada", "error");
          return;
        }

        currentStoreForQR = store;

        // Actualizar información de la tienda en el modal
        document.getElementById("qrStoreName").textContent = store.nombre;
        document.getElementById("qrStoreId").textContent = store.id;

        // Limpiar QR anterior si existe
        const qrContainer = document.getElementById("qrCodeContainer");
        qrContainer.innerHTML = "";

        // Generar nuevo código QR con el ID de la tienda
        currentQRCode = new QRCode(qrContainer, {
          text: store.id.toString(),
          width: 256,
          height: 256,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H,
        });

        // Mostrar el modal
        document.getElementById("qrModal").classList.remove("hidden");

        console.log(
          "✅ QR generado para tienda:",
          store.nombre,
          "ID:",
          store.id
        );
      }

      /**
       * Cierra el modal del QR
       */
      function closeQRModal() {
        document.getElementById("qrModal").classList.add("hidden");
        currentQRCode = null;
        currentStoreForQR = null;
      }

      /**
       * Descarga el código QR como imagen PNG
       */
      function downloadQR() {
        if (!currentStoreForQR) {
          showNotification("No hay QR para descargar", "error");
          return;
        }

        try {
          const qrCanvas = document.querySelector("#qrCodeContainer canvas");
          if (!qrCanvas) {
            showNotification("Error al obtener el código QR", "error");
            return;
          }

          // Convertir canvas a blob y descargar
          qrCanvas.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `QR_Tienda_${
              currentStoreForQR.id
            }_${currentStoreForQR.nombre.replace(/\s+/g, "_")}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showNotification("QR descargado exitosamente", "success");
          });
        } catch (error) {
          console.error("Error al descargar QR:", error);
          showNotification("Error al descargar el QR", "error");
        }
      }

      /**
       * Imprime el código QR
       */
      function printQR() {
        if (!currentStoreForQR) {
          showNotification("No hay QR para imprimir", "error");
          return;
        }

        try {
          const qrCanvas = document.querySelector("#qrCodeContainer canvas");
          if (!qrCanvas) {
            showNotification("Error al obtener el código QR", "error");
            return;
          }

          // Crear una ventana de impresión
          const printWindow = window.open("", "_blank");
          const qrImage = qrCanvas.toDataURL("image/png");

          printWindow.document.write(`
            <!DOCTYPE html>
            <html>
              <head>
                <title>QR - ${currentStoreForQR.nombre}</title>
                <style>
                  body {
                    font-family: Arial, sans-serif;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    min-height: 100vh;
                    margin: 0;
                    padding: 20px;
                  }
                  h1 {
                    font-size: 24px;
                    margin-bottom: 10px;
                    color: #333;
                  }
                  .store-info {
                    text-align: center;
                    margin-bottom: 20px;
                    color: #666;
                  }
                  img {
                    max-width: 400px;
                    border: 2px solid #e5e7eb;
                    padding: 20px;
                    background: white;
                  }
                  .footer {
                    margin-top: 20px;
                    font-size: 12px;
                    color: #999;
                  }
                  @media print {
                    body {
                      padding: 0;
                    }
                  }
                </style>
              </head>
              <body>
                <h1>${currentStoreForQR.nombre}</h1>
                <div class="store-info">
                  <p><strong>ID:</strong> ${currentStoreForQR.id}</p>
                  <p><strong>Dirección:</strong> ${currentStoreForQR.direccion}</p>
                </div>
                <img src="${qrImage}" alt="Código QR">
                <div class="footer">
                  <p>Escanea este código para registrar tu visita</p>
                </div>
              </body>
            </html>
          `);

          printWindow.document.close();
          printWindow.focus();

          // Esperar a que cargue la imagen antes de imprimir
          setTimeout(() => {
            printWindow.print();
          }, 250);

          showNotification("Preparando impresión...", "info");
        } catch (error) {
          console.error("Error al imprimir QR:", error);
          showNotification("Error al imprimir el QR", "error");
        }
      }

      // Exportar funciones globalmente
      window.generateQR = generateQR;
      window.closeQRModal = closeQRModal;
      window.downloadQR = downloadQR;
      window.printQR = printQR;
    </script>
  </body>
</html>
