<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Foto del Estante - Empleado</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="manifest" href="../../manifest.json" />
    <link rel="stylesheet" href="../../assets/css/styles.css" />

    <style>
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .camera-container {
        background: rgba(0, 0, 0, 0.9);
        border-radius: 20px;
        overflow: hidden;
        border: 4px solid rgba(255, 255, 255, 0.3);
      }

      .camera-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding: 20px;
      }

      .camera-controls {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 40px;
      }

      .capture-button {
        width: 70px;
        height: 70px;
        background: white;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      .capture-button:hover {
        transform: scale(1.1);
      }

      .capture-button.capturing {
        background: #ef4444;
        animation: capture-flash 0.3s ease-in-out;
      }

      @keyframes capture-flash {
        0% { background: white; }
        50% { background: #ef4444; }
        100% { background: white; }
      }

      .mobile-header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .photo-preview {
        max-width: 100%;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      }
    </style>
  </head>
  <body>
    <!-- Header Móvil -->
    <div class="mobile-header sticky top-0 z-50">
      <div class="max-w-md mx-auto px-4 py-3">
        <div class="flex items-center space-x-3">
          <button
            onclick="volverAtras()"
            class="p-2 text-gray-600 hover:text-gray-800"
          >
            <i class="fas fa-arrow-left text-xl"></i>
          </button>
          <div>
            <h1 class="text-lg font-bold text-gray-800">Foto del Estante</h1>
            <p class="text-sm text-gray-600" id="nombreTienda">
              Documentar productos
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenido Principal -->
    <div class="max-w-md mx-auto px-4 pb-6">
      <!-- Instrucciones -->
      <div class="bg-white bg-opacity-90 rounded-lg p-4 mt-4 mb-6 shadow-lg">
        <div class="flex items-start space-x-3">
          <div
            class="w-8 h-8 bg-red-400 rounded-full flex items-center justify-center flex-shrink-0"
          >
            <i class="fas fa-exclamation text-white text-sm"></i>
          </div>
          <div>
            <h3 class="font-semibold text-gray-800 mb-1">¡Importante!</h3>
            <p class="text-sm text-gray-600">
              Es <strong>obligatorio</strong> tomar una foto del estante donde
              están los productos. No podrás continuar sin esta foto.
            </p>
          </div>
        </div>
      </div>

      <!-- Cámara / Vista previa -->
      <div
        class="camera-container relative mb-6 aspect-[4/3]"
        id="cameraContainer"
      >
        <!-- Estado inicial: Cámara -->
        <div
          id="cameraView"
          class="w-full h-full bg-gray-900 flex items-center justify-center relative"
        >
          <div class="text-white text-center">
            <i class="fas fa-camera text-4xl mb-3 opacity-50"></i>
            <p class="text-sm opacity-75">Iniciando cámara...</p>
          </div>

          <!-- Controles de cámara -->
          <div class="camera-controls">
            <button
              onclick="alternarFlash()"
              id="flashBtn"
              class="w-12 h-12 bg-black bg-opacity-50 rounded-full flex items-center justify-center text-white"
            >
              <i class="fas fa-bolt text-lg"></i>
            </button>

            <button
              onclick="tomarFoto()"
              id="captureBtn"
              class="capture-button"
            >
              <i class="fas fa-camera text-gray-800 text-xl"></i>
            </button>

            <button
              onclick="cambiarCamara()"
              class="w-12 h-12 bg-black bg-opacity-50 rounded-full flex items-center justify-center text-white"
            >
              <i class="fas fa-sync-alt text-lg"></i>
            </button>
          </div>
        </div>

        <!-- Vista previa de foto tomada -->
        <div
          id="photoPreview"
          class="w-full h-full flex items-center justify-center p-4 hidden"
        >
          <img
            id="capturedPhoto"
            src=""
            alt="Foto capturada"
            class="photo-preview"
          />
        </div>
      </div>

      <!-- Estado de la foto -->
      <div
        id="photoStatus"
        class="bg-white bg-opacity-90 rounded-lg p-4 mb-6 shadow-lg"
      >
        <div class="flex items-center space-x-3">
          <div class="w-3 h-3 bg-red-400 rounded-full"></div>
          <span class="text-gray-800 font-medium"
            >Foto requerida - Sin capturar</span
          >
        </div>
      </div>

      <!-- Resumen de productos (si hay) -->
      <div
        id="resumenProductos"
        class="bg-white bg-opacity-90 rounded-lg p-4 mb-6 shadow-lg"
      >
        <h3 class="font-bold text-gray-800 mb-3 flex items-center">
          <i class="fas fa-box mr-2 text-gray-700"></i>
          Productos seleccionados
        </h3>
        <div id="listaProductos" class="text-sm text-gray-600">Cargando...</div>
      </div>
    </div>

    <!-- Botones flotantes -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg">
      <div class="max-w-md mx-auto px-4 py-3">
        <div class="flex space-x-3">
          <button
            onclick="retomarFoto()"
            id="btnRetomarFoto"
            class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-lg font-medium hidden"
          >
            <i class="fas fa-redo mr-2"></i>Retomar foto
          </button>
          <button
            onclick="finalizarVisita()"
            id="btnFinalizar"
            class="flex-1 btn-primary py-3 rounded-lg font-medium disabled:bg-gray-300 disabled:cursor-not-allowed"
            disabled
          >
            <i class="fas fa-check mr-2"></i>Finalizar visita
          </button>
        </div>
      </div>
    </div>

    <!-- Modal de confirmación -->
    <div
      id="modalConfirmacion"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden"
    >
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-sm w-full p-6">
          <div class="text-center">
            <div
              class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4"
            >
              <i class="fas fa-question-circle text-gray-600 text-2xl"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-800 mb-2">
              Finalizar Visita
            </h3>
            <p class="text-gray-600 mb-6">
              ¿Estás seguro de que quieres finalizar esta visita? Esta acción no
              se puede deshacer.
            </p>
            <div class="flex space-x-3">
              <button
                onclick="cancelarFinalizacion()"
                class="flex-1 btn-secondary py-2 rounded-lg"
              >
                Cancelar
              </button>
              <button
                onclick="confirmarFinalizacion()"
                class="flex-1 btn-primary py-2 rounded-lg"
              >
                Confirmar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="../../assets/js/utils.js"></script>
    <script src="../../assets/js/app.js"></script>
    <script src="../../assets/js/auth.js"></script>
    <script src="../../assets/js/employee-data.js"></script>

    <script>
      // Proteger página solo para empleados
      protectPage("empleado");

      let tiendaActual;
      let empleadoActual;
      let datosVisita;
      let fotoCapturada = null;
      let flashActivo = false;

      function initCamara() {
        empleadoActual = getCurrentUser();

        // Recuperar datos de la visita
        const datosVisitaJSON = sessionStorage.getItem("datosVisitaActual");
        if (!datosVisitaJSON) {
          alert("No hay datos de visita");
          window.location.href = "./dashboard.html";
          return;
        }

        datosVisita = JSON.parse(datosVisitaJSON);

        // Obtener información de la tienda
        const tiendas = getTiendasAsignadasEmpleado(empleadoActual.id);
        tiendaActual = tiendas.find((t) => t.id === datosVisita.tiendaId);

        if (!tiendaActual) {
          alert("Tienda no encontrada");
          window.location.href = "./dashboard.html";
          return;
        }

        // Actualizar información en la UI
        document.getElementById("nombreTienda").textContent =
          tiendaActual.nombre;

        // Mostrar resumen de productos
        mostrarResumenProductos();

        // Simular inicialización de cámara
        setTimeout(() => {
          document.getElementById("cameraView").innerHTML = `
            <div class="w-full h-full bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center relative">
              <div class="text-white text-center">
                <i class="fas fa-camera text-3xl mb-2 opacity-75"></i>
                <p class="text-xs opacity-50">Vista de cámara - Apunta al estante</p>
              </div>
              
              <!-- Controles de cámara -->
              <div class="camera-controls">
                <button onclick="alternarFlash()" id="flashBtn" class="w-12 h-12 bg-black bg-opacity-50 rounded-full flex items-center justify-center text-white">
                  <i class="fas fa-bolt text-lg ${
                    flashActivo ? "text-yellow-400" : ""
                  }"></i>
                </button>
                
                <button onclick="tomarFoto()" id="captureBtn" class="capture-button">
                  <i class="fas fa-camera text-gray-800 text-xl"></i>
                </button>
                
                <button onclick="cambiarCamara()" class="w-12 h-12 bg-black bg-opacity-50 rounded-full flex items-center justify-center text-white">
                  <i class="fas fa-sync-alt text-lg"></i>
                </button>
              </div>
            </div>
          `;
        }, 1000);
      }

      function mostrarResumenProductos() {
        const container = document.getElementById("listaProductos");

        if (!datosVisita.productos || datosVisita.productos.length === 0) {
          container.innerHTML =
            '<em class="text-gray-500">Sin productos seleccionados</em>';
          return;
        }

        const totalProductos = datosVisita.productos.reduce(
          (sum, p) => sum + p.cantidad,
          0
        );

        container.innerHTML = `
          <div class="space-y-2">
            ${datosVisita.productos
              .map(
                (producto) => `
              <div class="flex justify-between items-center">
                <span>${producto.nombre}</span>
                <span class="font-medium">${producto.cantidad} unidades</span>
              </div>
            `
              )
              .join("")}
            <div class="border-t pt-2 mt-2 font-semibold">
              Total: ${totalProductos} productos
            </div>
          </div>
        `;
      }

      function alternarFlash() {
        flashActivo = !flashActivo;
        const flashBtn = document.getElementById("flashBtn");
        const icon = flashBtn.querySelector("i");

        if (flashActivo) {
          icon.classList.add("text-yellow-400");
          showNotificationSafe("Flash activado", "info");
        } else {
          icon.classList.remove("text-yellow-400");
          showNotificationSafe("Flash desactivado", "info");
        }
      }

      function cambiarCamara() {
        showNotificationSafe("Cambiando cámara...", "info");
        // Simular cambio de cámara (frontal/trasera)
        setTimeout(() => {
          showNotificationSafe("Cámara trasera activada", "success");
        }, 500);
      }

      function tomarFoto() {
        const captureBtn = document.getElementById("captureBtn");
        captureBtn.classList.add("capturing");

        // Simular captura de foto
        setTimeout(() => {
          captureBtn.classList.remove("capturing");

          // Simular foto capturada (usando una imagen placeholder)
          const fotoBase64 =
            "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAABAAEDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAv/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwCdABmX/9k=";

          fotoCapturada = fotoBase64;

          // Mostrar preview
          document.getElementById("cameraView").classList.add("hidden");
          document.getElementById("photoPreview").classList.remove("hidden");
          document.getElementById("capturedPhoto").src = fotoBase64;

          // Actualizar estado
          document.getElementById("photoStatus").innerHTML = `
            <div class="flex items-center space-x-3">
              <div class="w-3 h-3 bg-green-400 rounded-full"></div>
              <span class="text-gray-800 font-medium">Foto capturada correctamente</span>
            </div>
          `;

          // Habilitar botones
          document.getElementById("btnRetomarFoto").classList.remove("hidden");
          document.getElementById("btnFinalizar").disabled = false;
          document
            .getElementById("btnFinalizar")
            .classList.remove(
              "disabled:bg-gray-300",
              "disabled:cursor-not-allowed"
            );

          showNotificationSafe("Foto capturada exitosamente", "success");
        }, 300);
      }

      function retomarFoto() {
        // Volver a la vista de cámara
        document.getElementById("photoPreview").classList.add("hidden");
        document.getElementById("cameraView").classList.remove("hidden");
        document.getElementById("btnRetomarFoto").classList.add("hidden");

        // Resetear estado
        fotoCapturada = null;
        document.getElementById("photoStatus").innerHTML = `
          <div class="flex items-center space-x-3">
            <div class="w-3 h-3 bg-red-400 rounded-full"></div>
            <span class="text-gray-800 font-medium">Foto requerida - Sin capturar</span>
          </div>
        `;

        document.getElementById("btnFinalizar").disabled = true;
        document
          .getElementById("btnFinalizar")
          .classList.add("disabled:bg-gray-300", "disabled:cursor-not-allowed");
      }

      function volverAtras() {
        if (fotoCapturada) {
          if (confirm("¿Estás seguro? Se perderá la foto capturada.")) {
            window.location.href = "./productos-visita.html";
          }
        } else {
          window.location.href = "./productos-visita.html";
        }
      }

      function finalizarVisita() {
        if (!fotoCapturada) {
          alert("Debes tomar una foto del estante antes de continuar");
          return;
        }

        document.getElementById("modalConfirmacion").classList.remove("hidden");
      }

      function cancelarFinalizacion() {
        document.getElementById("modalConfirmacion").classList.add("hidden");
      }

      function confirmarFinalizacion() {
        // Preparar datos completos de la visita
        const datosCompletos = {
          ...datosVisita,
          fotoEstante: fotoCapturada,
          qrCode: simularEscaneoQR(tiendaActual.id),
          observaciones: "Visita completada desde la aplicación móvil",
        };

        // Completar visita
        const pedidoCompleto = completarVisitaTienda(datosCompletos);

        if (pedidoCompleto) {
          // Limpiar datos de sesión
          sessionStorage.removeItem("tiendaEnVisita");
          sessionStorage.removeItem("datosVisitaActual");
          sessionStorage.removeItem("tiendaAVisitar");

          showNotificationSafe("Visita completada exitosamente", "success");

          // Redirigir al dashboard con un delay
          setTimeout(() => {
            window.location.href = "./dashboard.html";
          }, 1500);
        } else {
          alert("Error al completar la visita");
        }
      }

      // Inicializar cuando la página carga
      document.addEventListener("DOMContentLoaded", initCamara);
    </script>
  </body>
</html>
