<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Foto del Estante - Empleado</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="manifest" href="../../manifest.json" />
    <link rel="stylesheet" href="../../assets/css/styles.css" />

    <style>
      body {
        background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
        min-height: 100vh;
      }

      .camera-container {
        background: rgba(0, 0, 0, 0.9);
        border-radius: 20px;
        overflow: hidden;
        border: 4px solid rgba(255, 255, 255, 0.3);
      }

      .camera-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding: 20px;
      }

      .camera-controls {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 40px;
      }

      .capture-button {
        width: 70px;
        height: 70px;
        background: white;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      .capture-button:hover {
        transform: scale(1.1);
      }

      .capture-button.capturing {
        background: #ef4444;
        animation: capture-flash 0.3s ease-in-out;
      }

      @keyframes capture-flash {
        0% {
          background: white;
        }
        50% {
          background: #ef4444;
        }
        100% {
          background: white;
        }
      }

      .mobile-header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .photo-preview {
        max-width: 100%;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      }
    </style>
  </head>
  <body>
    <!-- Header M√≥vil -->
    <div class="mobile-header sticky top-0 z-50">
      <div class="max-w-md mx-auto px-4 py-3">
        <div class="flex items-center space-x-3">
          <button
            onclick="volverAtras()"
            class="p-2 text-gray-600 hover:text-gray-800"
          >
            <i class="fas fa-arrow-left text-xl"></i>
          </button>
          <div>
            <h1 class="text-lg font-bold text-gray-800">Foto del Estante</h1>
            <p class="text-sm text-gray-600" id="nombreTienda">
              Documentar productos
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenido Principal -->
    <div class="max-w-md mx-auto px-4 pb-6">
      <!-- Instrucciones -->
      <div class="bg-white bg-opacity-90 rounded-lg p-4 mt-4 mb-6 shadow-lg">
        <div class="flex items-start space-x-3">
          <div
            class="w-8 h-8 bg-red-400 rounded-full flex items-center justify-center flex-shrink-0"
          >
            <i class="fas fa-exclamation text-white text-sm"></i>
          </div>
          <div>
            <h3 class="font-semibold text-gray-800 mb-1">¬°Importante!</h3>
            <p class="text-sm text-gray-600">
              Es <strong>obligatorio</strong> tomar una foto del estante donde
              est√°n los productos. No podr√°s continuar sin esta foto.
            </p>
          </div>
        </div>
      </div>

      <!-- C√°mara / Vista previa -->
      <div
        class="camera-container relative mb-6 aspect-[4/3]"
        id="cameraContainer"
      >
        <!-- Estado inicial: C√°mara -->
        <div
          id="cameraView"
          class="w-full h-full bg-gray-900 flex items-center justify-center relative"
        >
          <div class="text-white text-center">
            <i class="fas fa-camera text-4xl mb-3 opacity-50"></i>
            <p class="text-sm opacity-75">Iniciando c√°mara...</p>
          </div>

          <!-- Controles de c√°mara -->
          <div class="camera-controls">
            <button
              onclick="alternarFlash()"
              id="flashBtn"
              class="w-12 h-12 bg-black bg-opacity-50 rounded-full flex items-center justify-center text-white"
            >
              <i class="fas fa-bolt text-lg"></i>
            </button>

            <button
              onclick="tomarFoto()"
              id="captureBtn"
              class="capture-button"
            >
              <i class="fas fa-camera text-gray-800 text-xl"></i>
            </button>

            <button
              onclick="cambiarCamara()"
              class="w-12 h-12 bg-black bg-opacity-50 rounded-full flex items-center justify-center text-white"
            >
              <i class="fas fa-sync-alt text-lg"></i>
            </button>
          </div>
        </div>

        <!-- Vista previa de foto tomada -->
        <div
          id="photoPreview"
          class="w-full h-full flex items-center justify-center p-4 hidden"
        >
          <img
            id="capturedPhoto"
            src=""
            alt="Foto capturada"
            class="photo-preview"
          />
        </div>
      </div>

      <!-- Estado de la foto -->
      <div
        id="photoStatus"
        class="bg-white bg-opacity-90 rounded-lg p-4 mb-6 shadow-lg"
      >
        <div class="flex items-center space-x-3">
          <div class="w-3 h-3 bg-red-400 rounded-full"></div>
          <span class="text-gray-800 font-medium"
            >Foto requerida - Sin capturar</span
          >
        </div>
      </div>

      <!-- Resumen de productos (si hay) -->
      <div
        id="resumenProductos"
        class="bg-white bg-opacity-90 rounded-lg p-4 mb-6 shadow-lg"
      >
        <h3 class="font-bold text-gray-800 mb-3 flex items-center">
          <i class="fas fa-box mr-2 text-gray-700"></i>
          Productos seleccionados
        </h3>
        <div id="listaProductos" class="text-sm text-gray-600">Cargando...</div>
      </div>
    </div>

    <!-- Botones flotantes -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg">
      <div class="max-w-md mx-auto px-4 py-3">
        <div class="flex space-x-3">
          <button
            onclick="retomarFoto()"
            id="btnRetomarFoto"
            class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-lg font-medium hidden"
          >
            <i class="fas fa-redo mr-2"></i>Retomar foto
          </button>
          <button
            onclick="finalizarVisita()"
            id="btnFinalizar"
            class="flex-1 btn-primary py-3 rounded-lg font-medium disabled:bg-gray-300 disabled:cursor-not-allowed"
            disabled
          >
            <i class="fas fa-check mr-2"></i>Finalizar visita
          </button>
        </div>
      </div>
    </div>

    <!-- Modal de confirmaci√≥n -->
    <div
      id="modalConfirmacion"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden"
    >
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-sm w-full p-6">
          <div class="text-center">
            <div
              class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4"
            >
              <i class="fas fa-question-circle text-gray-600 text-2xl"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-800 mb-2">
              Finalizar Visita
            </h3>
            <p class="text-gray-600 mb-6">
              ¬øEst√°s seguro de que quieres finalizar esta visita? Esta acci√≥n no
              se puede deshacer.
            </p>
            <div class="flex space-x-3">
              <button
                onclick="cancelarFinalizacion()"
                class="flex-1 btn-secondary py-2 rounded-lg"
              >
                Cancelar
              </button>
              <button
                onclick="confirmarFinalizacion()"
                class="flex-1 btn-primary py-2 rounded-lg"
              >
                Confirmar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="../../assets/js/utils.js"></script>
    <script src="../../assets/js/API_BASE.js"></script>
    <script src="../../assets/js/offline-manager.js"></script>
    <script src="../../assets/js/auth.js"></script>
    <script src="../../assets/js/app.js"></script>

    <script>
      // Proteger p√°gina solo para empleados
      protectPage("empleado");

      let empleadoActual;
      let datosVisita;
      let fotoCapturada = null; // Base64 string
      let stream = null;
      let videoElement = null;
      let usarCamaraFrontal = false;

      async function initCamara() {
        empleadoActual = getCurrentUser();

        // Recuperar datos de la visita
        const datosVisitaJSON = sessionStorage.getItem("datosVisitaActual");
        if (!datosVisitaJSON) {
          showNotification("No hay datos de visita", "error");
          setTimeout(() => {
            window.location.href = "./dashboard.html";
          }, 2000);
          return;
        }

        datosVisita = JSON.parse(datosVisitaJSON);

        // Actualizar informaci√≥n en la UI
        document.getElementById("nombreTienda").textContent =
          datosVisita.tiendaNombre;

        // Mostrar resumen de productos
        mostrarResumenProductos();

        // Iniciar c√°mara real
        await iniciarCamaraReal();
      }

      async function iniciarCamaraReal() {
        try {
          console.log("üì∑ Iniciando c√°mara real...");

          // Solicitar permisos de c√°mara
          const constraints = {
            video: {
              facingMode: usarCamaraFrontal ? "user" : "environment",
              width: { ideal: 1920 },
              height: { ideal: 1080 },
            },
            audio: false,
          };

          stream = await navigator.mediaDevices.getUserMedia(constraints);

          // Crear elemento video
          const cameraView = document.getElementById("cameraView");
          cameraView.innerHTML = `
            <video id="videoPreview" autoplay playsinline class="w-full h-full object-cover"></video>
            
            <!-- Controles de c√°mara -->
            <div class="camera-controls">
              <button onclick="cambiarCamara()" class="w-12 h-12 bg-black bg-opacity-50 rounded-full flex items-center justify-center text-white">
                <i class="fas fa-sync-alt text-lg"></i>
              </button>
              
              <button onclick="tomarFoto()" id="captureBtn" class="capture-button">
                <i class="fas fa-camera text-gray-800 text-xl"></i>
              </button>
              
              <div class="w-12 h-12"></div>
            </div>
          `;

          videoElement = document.getElementById("videoPreview");
          videoElement.srcObject = stream;

          console.log("‚úÖ C√°mara iniciada correctamente");
          showNotification("C√°mara lista", "success");
        } catch (error) {
          console.error("‚ùå Error al iniciar c√°mara:", error);
          showNotification(
            "Error al acceder a la c√°mara: " + error.message,
            "error"
          );

          // Mostrar mensaje de error en la UI
          document.getElementById("cameraView").innerHTML = `
            <div class="text-white text-center p-6">
              <i class="fas fa-exclamation-triangle text-4xl mb-3 text-red-400"></i>
              <p class="text-sm mb-2">No se pudo acceder a la c√°mara</p>
              <p class="text-xs opacity-75">${error.message}</p>
              <button onclick="iniciarCamaraReal()" class="mt-4 bg-white text-gray-800 px-4 py-2 rounded-lg text-sm">
                Reintentar
              </button>
            </div>
          `;
        }
      }

      function mostrarResumenProductos() {
        const container = document.getElementById("listaProductos");

        if (!datosVisita.productos || datosVisita.productos.length === 0) {
          container.innerHTML =
            '<em class="text-gray-500">Sin productos seleccionados</em>';
          return;
        }

        const totalProductos = datosVisita.productos.reduce(
          (sum, p) => sum + p.cantidad,
          0
        );

        container.innerHTML = `
          <div class="space-y-2">
            ${datosVisita.productos
              .map(
                (producto) => `
              <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                <span class="font-medium">${producto.nombre}</span>
                <span class="text-gray-600">${producto.cantidad} unidades</span>
              </div>
            `
              )
              .join("")}
            <div class="border-t pt-2 mt-2 font-semibold">
              Total: ${totalProductos} productos
            </div>
          </div>
        `;
      }

      async function cambiarCamara() {
        // Detener stream actual
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
        }

        // Cambiar entre c√°mara frontal y trasera
        usarCamaraFrontal = !usarCamaraFrontal;
        showNotification(
          usarCamaraFrontal
            ? "Cambiando a c√°mara frontal..."
            : "Cambiando a c√°mara trasera...",
          "info"
        );

        await iniciarCamaraReal();
      }

      async function tomarFoto() {
        if (!videoElement) {
          showNotification("C√°mara no disponible", "error");
          return;
        }

        try {
          console.log("üì∏ Tomando foto...");

          const captureBtn = document.getElementById("captureBtn");
          captureBtn.classList.add("capturing");

          // Crear canvas para capturar frame del video
          const canvas = document.createElement("canvas");
          canvas.width = videoElement.videoWidth;
          canvas.height = videoElement.videoHeight;

          const ctx = canvas.getContext("2d");
          ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

          // Comprimir imagen con m√°s compresi√≥n para reducir tama√±o
          const imagenComprimida = await comprimirImagen(canvas, 800, 0.6);
          fotoCapturada = imagenComprimida;

          console.log("‚úÖ Foto capturada", {
            dimensiones: `${canvas.width}x${canvas.height}`,
            tama√±oBase64: `${(fotoCapturada.length / 1024).toFixed(2)} KB`,
          });

          setTimeout(() => {
            captureBtn.classList.remove("capturing");

            // Detener stream de c√°mara
            if (stream) {
              stream.getTracks().forEach((track) => track.stop());
            }

            // Mostrar preview de la foto
            document.getElementById("cameraView").classList.add("hidden");
            document.getElementById("photoPreview").classList.remove("hidden");
            document.getElementById("capturedPhoto").src = fotoCapturada;

            // Actualizar estado
            document.getElementById("photoStatus").innerHTML = `
              <div class="flex items-center space-x-3">
                <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                <span class="text-gray-800 font-medium">Foto capturada correctamente</span>
              </div>
            `;

            // Habilitar botones
            document
              .getElementById("btnRetomarFoto")
              .classList.remove("hidden");
            document.getElementById("btnFinalizar").disabled = false;
            document
              .getElementById("btnFinalizar")
              .classList.remove(
                "disabled:bg-gray-300",
                "disabled:cursor-not-allowed"
              );

            showNotification("Foto capturada exitosamente", "success");
          }, 300);
        } catch (error) {
          console.error("‚ùå Error al tomar foto:", error);
          showNotification("Error al capturar foto: " + error.message, "error");
        }
      }

      async function comprimirImagen(canvas, maxWidth = 1024, quality = 0.8) {
        return new Promise((resolve) => {
          let width = canvas.width;
          let height = canvas.height;

          // Redimensionar si es muy grande
          if (width > maxWidth) {
            height = (height * maxWidth) / width;
            width = maxWidth;
          }

          const resizedCanvas = document.createElement("canvas");
          resizedCanvas.width = width;
          resizedCanvas.height = height;

          const ctx = resizedCanvas.getContext("2d");
          ctx.drawImage(canvas, 0, 0, width, height);

          // Convertir a base64 con compresi√≥n JPEG
          const compressed = resizedCanvas.toDataURL("image/jpeg", quality);
          resolve(compressed);
        });
      }

      function extraerBase64Puro(dataUrl) {
        // Eliminar el prefijo "data:image/jpeg;base64," si existe
        if (dataUrl.startsWith("data:")) {
          return dataUrl.split(",")[1];
        }
        return dataUrl;
      }

      function base64ToBlob(base64, mimeType = "image/jpeg") {
        // Decodificar base64 a binario
        const byteCharacters = atob(base64);
        const byteArrays = [];

        for (let offset = 0; offset < byteCharacters.length; offset += 512) {
          const slice = byteCharacters.slice(offset, offset + 512);

          const byteNumbers = new Array(slice.length);
          for (let i = 0; i < slice.length; i++) {
            byteNumbers[i] = slice.charCodeAt(i);
          }

          const byteArray = new Uint8Array(byteNumbers);
          byteArrays.push(byteArray);
        }

        return new Blob(byteArrays, { type: mimeType });
      }

      function retomarFoto() {
        // Volver a la vista de c√°mara
        document.getElementById("photoPreview").classList.add("hidden");
        document.getElementById("cameraView").classList.remove("hidden");
        document.getElementById("btnRetomarFoto").classList.add("hidden");

        // Resetear estado
        fotoCapturada = null;
        document.getElementById("photoStatus").innerHTML = `
          <div class="flex items-center space-x-3">
            <div class="w-3 h-3 bg-red-400 rounded-full"></div>
            <span class="text-gray-800 font-medium">Foto requerida - Sin capturar</span>
          </div>
        `;

        document.getElementById("btnFinalizar").disabled = true;
        document
          .getElementById("btnFinalizar")
          .classList.add("disabled:bg-gray-300", "disabled:cursor-not-allowed");

        // Reiniciar c√°mara
        iniciarCamaraReal();
      }

      function volverAtras() {
        // Detener stream si est√° activo
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
        }

        if (fotoCapturada) {
          if (confirm("¬øEst√°s seguro? Se perder√° la foto capturada.")) {
            window.location.href = "./productos-visita.html";
          }
        } else {
          window.location.href = "./productos-visita.html";
        }
      }

      function finalizarVisita() {
        if (!fotoCapturada) {
          showNotification(
            "Debes tomar una foto del estante antes de continuar",
            "error"
          );
          return;
        }

        document.getElementById("modalConfirmacion").classList.remove("hidden");
      }

      function cancelarFinalizacion() {
        document.getElementById("modalConfirmacion").classList.add("hidden");
      }

      async function confirmarFinalizacion() {
        if (!fotoCapturada) {
          showNotification("Debes tomar una foto primero", "error");
          return;
        }

        try {
          showLoader();

          const orderId = datosVisita.orderId;
          const isOfflineOrder = datosVisita.isOfflineOrder;

          if (!orderId) {
            hideLoader();
            console.error("‚ùå No se encontr√≥ el ID del pedido:", datosVisita);
            showNotification("Error: No se encontr√≥ el ID del pedido", "error");
            return;
          }

          console.log("üì∏ Procesando imagen para pedido ID:", orderId);
          console.log("üì¥ Pedido offline:", isOfflineOrder);

          // Extraer base64 puro (sin el prefijo data:image/jpeg;base64,)
          const base64Puro = extraerBase64Puro(fotoCapturada);

          // Verificar si estamos online u offline
          const isOnline =
            typeof offlineManager !== "undefined" && offlineManager
              ? offlineManager.checkOnlineStatus()
              : navigator.onLine;

          if (isOnline && !isOfflineOrder) {
            // MODO ONLINE: Subir imagen al servidor
            console.log("üåê MODO ONLINE: Subiendo imagen al servidor...");

            // Convertir base64 puro a Blob
            const blob = base64ToBlob(base64Puro);

            console.log("üì¶ Datos de imagen:", {
              orderId: orderId,
              tama√±oBlob: `${(blob.size / 1024).toFixed(2)} KB`,
              tipoBlob: blob.type,
            });

            // Crear FormData con el archivo
            const formData = new FormData();
            formData.append("file", blob, "estante.jpg");

            console.log("üì§ Enviando FormData con archivo:", {
              hasFile: formData.has("file"),
              fileName: "estante.jpg",
            });

            try {
              // Subir imagen al endpoint /api/orders/img/{id}
              const response = await apiFetch(
                `${API_CONFIG.ENDPOINTS.ORDERS}/img/${orderId}`,
                {
                  method: "POST",
                  // NO enviar Content-Type, el navegador lo configurar√° autom√°ticamente con boundary
                  body: formData,
                }
              );

              if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                console.error("‚ùå Error al subir imagen:", errorData);

                if (errorData.trace) {
                  console.error(
                    "üî• Stack trace del servidor:",
                    errorData.trace
                  );
                }

                const errorMsg =
                  errorData.message ||
                  errorData.error ||
                  "Error desconocido del servidor";
                throw new Error(errorMsg);
              }

              const result = await response.json();
              console.log("‚úÖ Imagen subida correctamente:", result);

              showNotification("¬°Visita completada exitosamente!", "success");
            } catch (uploadError) {
              console.warn(
                "‚ö†Ô∏è Error al subir imagen online, guardando offline:",
                uploadError
              );

              // Si falla, guardar offline
              if (typeof offlineManager !== "undefined" && offlineManager) {
                await offlineManager.savePendingImage(orderId, base64Puro);
                showNotification(
                  "Imagen guardada localmente. Se subir√° cuando haya conexi√≥n.",
                  "info"
                );
              } else {
                throw uploadError;
              }
            }
          } else {
            // MODO OFFLINE o PEDIDO OFFLINE: Guardar imagen localmente
            console.log("üì¥ MODO OFFLINE: Guardando imagen localmente...");

            if (typeof offlineManager !== "undefined" && offlineManager) {
              await offlineManager.savePendingImage(orderId, base64Puro);
              console.log(
                "‚úÖ Imagen guardada localmente para pedido:",
                orderId
              );
              showNotification(
                "üì¥ Imagen guardada. Se subir√° cuando haya conexi√≥n.",
                "info"
              );
            } else {
              throw new Error("offlineManager no disponible");
            }
          }

          hideLoader();

          // Cerrar modal
          document.getElementById("modalConfirmacion").classList.add("hidden");

          // Limpiar datos de sesi√≥n
          sessionStorage.removeItem("tiendaEnVisita");
          sessionStorage.removeItem("datosVisitaActual");
          sessionStorage.removeItem("tiendaAVisitar");

          // Redirigir al dashboard
          setTimeout(() => {
            window.location.href = "./dashboard.html";
          }, 2000);
        } catch (error) {
          hideLoader();
          console.error("‚ùå Error al enviar pedido:", error);
          showNotification("Error al enviar pedido: " + error.message, "error");
          document.getElementById("modalConfirmacion").classList.add("hidden");
        }
      }

      // Limpiar stream al salir de la p√°gina
      window.addEventListener("beforeunload", () => {
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
        }
      });

      // Inicializar cuando la p√°gina carga
      document.addEventListener("DOMContentLoaded", initCamara);
    </script>
  </body>
</html>
