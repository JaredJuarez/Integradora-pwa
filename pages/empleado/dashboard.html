<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rutas del D√≠a - Empleado</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="manifest" href="../../manifest.json" />
    <link rel="stylesheet" href="../../assets/css/styles.css" />

    <!-- Service Worker -->
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("../../sw.js")
            .then((reg) =>
              console.log("‚úÖ Service Worker registrado:", reg.scope)
            )
            .catch((err) =>
              console.error("‚ùå Error al registrar Service Worker:", err)
            );
        });
      }
    </script>

    <style>
      /* Estilos espec√≠ficos para m√≥vil */
      body {
        background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
        min-height: 100vh;
      }

      .store-card {
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .store-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .store-card.completed {
        opacity: 0.6;
        background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
        color: white;
      }

      .mobile-header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .stats-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
    </style>
  </head>
  <body>
    <!-- Header M√≥vil -->
    <div class="mobile-header sticky top-0 z-50">
      <div class="max-w-md mx-auto px-4 py-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div
              class="w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center"
            >
              <i class="fas fa-truck text-white text-sm"></i>
            </div>
            <div>
              <h1 id="employeeName" class="text-lg font-bold text-gray-800">
                Carlos Mendoza
              </h1>
              <p class="text-sm text-gray-600">Rutas del d√≠a</p>
            </div>
          </div>
          <button
            onclick="logout()"
            class="p-2 text-gray-600 hover:text-red-500"
          >
            <i class="fas fa-sign-out-alt text-xl"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Contenido Principal -->
    <div class="max-w-md mx-auto px-4 pb-20">
      <!-- Estad√≠sticas R√°pidas -->
      <div class="grid grid-cols-3 gap-3 mt-4 mb-6">
        <div class="stats-card rounded-lg p-3 text-center">
          <div class="text-2xl font-bold text-gray-700" id="tiendasCompletadas">
            0
          </div>
          <div class="text-xs text-gray-600">Completadas</div>
        </div>
        <div class="stats-card rounded-lg p-3 text-center">
          <div
            class="text-2xl font-bold text-orange-600"
            id="tiendasPendientes"
          >
            0
          </div>
          <div class="text-xs text-gray-600">Tiendas</div>
        </div>
        <div class="stats-card rounded-lg p-3 text-center">
          <div
            class="text-2xl font-bold text-green-600"
            id="productosEntregados"
          >
            0
          </div>
          <div class="text-xs text-gray-600">Productos</div>
        </div>
      </div>

      <!-- Mensaje de estado -->
      <div id="estadoRuta" class="bg-white rounded-lg p-4 mb-4 shadow-md">
        <div class="flex items-center space-x-3">
          <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
          <span class="text-gray-800 font-medium"
            >Ruta activa - Listo para visitar tiendas</span
          >
        </div>
      </div>

      <!-- Badge de pedidos pendientes offline -->
      <div
        id="pendingOrdersBadge"
        class="hidden bg-yellow-100 border-l-4 border-yellow-500 rounded-lg p-4 mb-4 shadow-md"
      >
        <div class="flex items-center space-x-3">
          <i class="fas fa-clock text-yellow-600 text-xl"></i>
          <div class="flex-1">
            <p class="text-gray-800 font-medium">
              <span id="pendingOrdersCount">0</span> pedido(s) pendiente(s) de
              sincronizar
            </p>
            <p class="text-sm text-gray-600">
              Se enviar√°n autom√°ticamente cuando haya conexi√≥n
            </p>
          </div>
          <button
            onclick="sincronizarManual()"
            class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-medium"
          >
            <i class="fas fa-sync-alt mr-1"></i>
            Sincronizar
          </button>
        </div>
      </div>

      <!-- Lista de Tiendas -->
      <div class="space-y-4">
        <h2 class="text-white text-lg font-bold mb-3">
          <i class="fas fa-store mr-2"></i>Tiendas Asignadas
        </h2>

        <!-- Contenedor de las cards de tiendas -->
        <div id="tiendasContainer" class="space-y-3">
          <!-- Las cards se generar√°n din√°micamente -->
        </div>
      </div>

      <!-- Bot√≥n de acci√≥n flotante -->
      <div id="fabButton" class="fixed bottom-6 right-6 hidden">
        <button
          onclick="completarRuta()"
          class="w-14 h-14 bg-green-500 hover:bg-green-600 rounded-full shadow-lg flex items-center justify-center text-white"
        >
          <i class="fas fa-check text-xl"></i>
        </button>
      </div>

      <!-- Modal de completar ruta -->
      <div
        id="modalCompletarRuta"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden"
      >
        <div class="flex items-center justify-center min-h-screen p-4">
          <div class="bg-white rounded-lg max-w-sm w-full p-6">
            <div class="text-center">
              <div
                class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"
              >
                <i class="fas fa-check-circle text-green-500 text-2xl"></i>
              </div>
              <h3 class="text-lg font-bold text-gray-800 mb-2">
                ¬°Ruta Completada!
              </h3>
              <p class="text-gray-600 mb-6">
                Has terminado todas las visitas del d√≠a. ¬°Excelente trabajo!
              </p>
              <button
                onclick="cerrarModalRuta()"
                class="w-full btn-primary py-3 rounded-lg font-medium"
              >
                Entendido
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="../../assets/js/utils.js"></script>
    <script src="../../assets/js/API_BASE.js"></script>
    <script src="../../assets/js/offline-manager.js"></script>
    <script src="../../assets/js/auth.js"></script>
    <script src="../../assets/js/app.js"></script>
    <!-- Firebase Messaging (debe ser type="module") -->
    <script type="module" src="../../assets/js/firebase-messaging.js"></script>

    <script>
      // Proteger p√°gina solo para empleados
      protectPage("empleado");

      let empleadoActual;
      let estadisticas;

      async function initDashboard() {
        empleadoActual = getCurrentUser();
        if (!empleadoActual) {
          window.location.href = "../auth/login.html";
          return;
        }

        // Actualizar nombre del empleado
        document.getElementById("employeeName").textContent =
          empleadoActual.nombre || empleadoActual.email.split("@")[0];

        // SOLICITAR PERMISOS DE NOTIFICACIONES (REQUERIDO)
        console.log("üîî Iniciando solicitud de permisos de notificaciones...");

        // Esperar a que initEmployeeNotifications est√© disponible
        const maxAttempts = 10;
        let attempt = 0;

        while (
          typeof initEmployeeNotifications === "undefined" &&
          attempt < maxAttempts
        ) {
          console.log(
            `‚è≥ Esperando a que Firebase se inicialice... (${
              attempt + 1
            }/${maxAttempts})`
          );
          await new Promise((resolve) => setTimeout(resolve, 500));
          attempt++;
        }

        if (typeof initEmployeeNotifications === "function") {
          const token = await initEmployeeNotifications();

          if (!token) {
            console.error("‚ùå No se obtuvieron permisos de notificaciones");
            // La funci√≥n initEmployeeNotifications ya redirige al login
            return;
          }

          console.log("‚úÖ Permisos de notificaciones concedidos");
        } else {
          console.error("‚ùå Firebase Messaging no est√° disponible");
          showNotification(
            "Error al cargar el sistema de notificaciones",
            "error"
          );
        }

        // Precargar todos los datos necesarios
        await precargarDatosOffline();

        // Cargar datos
        await cargarTiendasAsignadas();

        // Mostrar badge de pedidos pendientes
        await mostrarPedidosPendientes();
      }

      async function precargarDatosOffline() {
        if (typeof offlineManager === "undefined" || !offlineManager) {
          console.warn("‚ö†Ô∏è offlineManager no disponible");
          return;
        }

        try {
          console.log("========================================");
          console.log("üöÄ PRECARGANDO DATOS EN DASHBOARD");
          console.log("========================================");

          const isOnline = offlineManager.checkOnlineStatus();

          if (!isOnline) {
            console.log("üì¥ Modo offline - usando datos en cach√©");
            return;
          }

          // LIMPIAR COMPLETAMENTE IndexedDB antes de cargar datos frescos
          console.log("üßπ Limpiando IndexedDB completamente...");
          try {
            await offlineManager.clearStores();
            await offlineManager.clearProducts();
            await offlineManager.clearEmployee();
            console.log("‚úÖ IndexedDB limpiado completamente");
          } catch (error) {
            console.error("‚ùå Error al limpiar IndexedDB:", error);
          }

          // Precargar tiendas y datos del empleado
          try {
            console.log("üè™ Precargando tiendas...");
            const storesResponse = await apiFetch(
              API_CONFIG.ENDPOINTS.STORES_COURIER
            );
            console.log(
              "üì° Respuesta tiendas:",
              storesResponse.status,
              storesResponse.ok
            );

            if (storesResponse.ok) {
              const storesData = await storesResponse.json();
              console.log("üì¶ Datos de tiendas recibidos:", storesData);

              if (storesData.data && Array.isArray(storesData.data)) {
                // Guardar tiendas frescas (IndexedDB ya fue limpiado)
                await offlineManager.cacheStores(storesData.data);
                console.log(
                  "‚úÖ Tiendas actualizadas completamente:",
                  storesData.data.length
                );

                // Extraer datos del empleado
                if (
                  storesData.data.length > 0 &&
                  storesData.data[0].assignedCourier
                ) {
                  const employeeData = {
                    id: storesData.data[0].assignedCourier.id,
                    name: storesData.data[0].assignedCourier.name,
                    email: storesData.data[0].assignedCourier.email,
                    role: "EMPLOYEE",
                    active: true,
                  };

                  // Guardar datos del empleado (IndexedDB ya fue limpiado)
                  await offlineManager.cacheEmployee(employeeData);
                  console.log(
                    "‚úÖ Empleado actualizado completamente:",
                    employeeData.name
                  );
                }
              }
            }
          } catch (error) {
            console.warn("‚ö†Ô∏è Error al precargar tiendas:", error);
          }

          // Precargar productos
          try {
            console.log("üì¶ Precargando productos...");
            const productsResponse = await apiFetch(
              API_CONFIG.ENDPOINTS.PRODUCTS
            );
            console.log(
              "üì° Respuesta productos:",
              productsResponse.status,
              productsResponse.ok
            );

            if (productsResponse.ok) {
              const productsData = await productsResponse.json();
              console.log("üì¶ Datos de productos recibidos:", productsData);

              let productsList = [];
              if (productsData.data && Array.isArray(productsData.data)) {
                productsList = productsData.data;
              } else if (Array.isArray(productsData)) {
                productsList = productsData;
              }

              const activeProducts = productsList.filter((p) => p.active);
              console.log(
                `üìä Productos activos: ${activeProducts.length} de ${productsList.length}`
              );

              if (activeProducts.length > 0) {
                // Guardar productos frescos (IndexedDB ya fue limpiado)
                await offlineManager.cacheProducts(activeProducts);
                console.log(
                  "‚úÖ Productos actualizados completamente:",
                  activeProducts.length
                );
              } else {
                console.warn("‚ö†Ô∏è No se encontraron productos activos");
              }
            }
          } catch (error) {
            console.warn("‚ö†Ô∏è Error al precargar productos:", error);
          }

          console.log("========================================");
          console.log("‚úÖ PRECARGA COMPLETADA EN DASHBOARD");
          console.log("========================================");
        } catch (error) {
          console.error("‚ùå Error en precarga:", error);
        }
      }

      async function mostrarPedidosPendientes() {
        if (typeof offlineManager === "undefined" || !offlineManager) {
          return;
        }

        try {
          const pendingOrders = await offlineManager.getPendingOrders();
          const badge = document.getElementById("pendingOrdersBadge");
          const countElement = document.getElementById("pendingOrdersCount");

          if (pendingOrders && pendingOrders.length > 0) {
            countElement.textContent = pendingOrders.length;
            badge.classList.remove("hidden");
            console.log(
              `üìã ${pendingOrders.length} pedidos pendientes de sincronizar`
            );
          } else {
            badge.classList.add("hidden");
          }
        } catch (error) {
          console.error("Error al cargar pedidos pendientes:", error);
        }
      }

      async function sincronizarManual() {
        if (typeof offlineManager === "undefined" || !offlineManager) {
          showNotification("Sistema offline no disponible", "error");
          return;
        }

        console.log("üîÑ Sincronizaci√≥n manual iniciada");

        try {
          await offlineManager.syncPendingOrders();

          // Recargar badge despu√©s de sincronizar
          await mostrarPedidosPendientes();

          // Recargar tiendas
          await cargarTiendasAsignadas();
        } catch (error) {
          console.error("Error en sincronizaci√≥n manual:", error);
          showNotification("Error al sincronizar: " + error.message, "error");
        }
      }

      async function cargarEstadisticas() {
        // Las estad√≠sticas se calculan desde los datos de tiendas cargadas
        // Esta funci√≥n ya no es necesaria con la API real
      }

      async function cargarTiendasAsignadas() {
        try {
          // Verificar que tenemos sesi√≥n y token
          const session = Storage.get("session");
          console.log("Sesi√≥n actual:", session);

          if (!session || !session.token) {
            throw new Error(
              "No hay token de autenticaci√≥n. Por favor inicie sesi√≥n nuevamente."
            );
          }

          showLoader();

          let tiendas = [];
          const isOnline =
            typeof offlineManager !== "undefined" && offlineManager
              ? offlineManager.checkOnlineStatus()
              : navigator.onLine;

          if (isOnline) {
            // Modo online: intentar cargar desde API
            try {
              const response = await apiFetch(
                API_CONFIG.ENDPOINTS.STORES_COURIER,
                {
                  method: "GET",
                }
              );

              if (response.ok) {
                const result = await response.json();
                tiendas = result.data || result;

                // Guardar en IndexedDB (ya fue limpiado en precargarDatosOffline)
                if (typeof offlineManager !== "undefined" && offlineManager) {
                  await offlineManager.cacheStores(tiendas);
                  console.log("‚úÖ Tiendas guardadas en IndexedDB");
                }
              }
            } catch (error) {
              console.warn(
                "Error al cargar desde API, intentando cache:",
                error
              );
              // Si falla online, intentar cache
              if (typeof offlineManager !== "undefined" && offlineManager) {
                tiendas = (await offlineManager.getCachedStores()) || [];
              }
            }
          } else {
            // Modo offline: cargar desde cache
            console.log("üì¥ Modo offline - cargando tiendas desde cache");
            if (typeof offlineManager !== "undefined" && offlineManager) {
              tiendas = (await offlineManager.getCachedStores()) || [];
              console.log("Tiendas desde cache:", tiendas);
            }
          }

          hideLoader();

          console.log("Tiendas a mostrar:", tiendas);
          const container = document.getElementById("tiendasContainer");

          if (!tiendas || tiendas.length === 0) {
            container.innerHTML = `
              <div class="bg-white rounded-lg p-6 text-center">
                <i class="fas fa-calendar-times text-gray-400 text-3xl mb-3"></i>
                <p class="text-gray-600">No hay tiendas asignadas${
                  !isOnline ? " (modo offline)" : ""
                }</p>
              </div>
            `;
            return;
          }

          // ORDENAR TIENDAS: Sin visitar primero, luego las visitadas
          const tiendasOrdenadas = tiendas.sort((a, b) => {
            // Si a no tiene visita y b s√≠, a va primero (return -1)
            if (!a.lastVisitDate && b.lastVisitDate) return -1;
            // Si a tiene visita y b no, b va primero (return 1)
            if (a.lastVisitDate && !b.lastVisitDate) return 1;
            // Si ambas tienen o no tienen visita, mantener orden por ID
            return a.id - b.id;
          });

          console.log("üìä Tiendas ordenadas:", tiendasOrdenadas);

          // Actualizar contador para sistema de actualizaci√≥n autom√°tica
          lastStoresCount = tiendasOrdenadas.length;

          // Actualizar estad√≠sticas
          document.getElementById("tiendasPendientes").textContent =
            tiendasOrdenadas.filter((t) => t.active).length;
          document.getElementById("tiendasCompletadas").textContent =
            tiendasOrdenadas.filter((t) => t.lastVisitDate).length;

          container.innerHTML = tiendasOrdenadas
            .map((tienda) => {
              const isCompleted = tienda.lastVisitDate !== null;
              const cardClass = isCompleted
                ? "store-card completed"
                : "store-card bg-white";
              const actionButton = isCompleted
                ? '<span class="text-white text-sm"><i class="fas fa-check-circle mr-1"></i>Completada</span>'
                : '<span class="text-gray-700 text-sm font-medium">Visitar <i class="fas fa-arrow-right ml-1"></i></span>';

              return `
              <div class="${cardClass} rounded-lg p-4 shadow-md ${
                isCompleted ? "" : "cursor-pointer"
              }" 
                   ${
                     isCompleted ? "" : `onclick="visitarTienda(${tienda.id})"`
                   }>
                <div class="flex items-start justify-between">
                  <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-2">
                      <i class="fas fa-store text-lg ${
                        isCompleted ? "text-white" : "text-gray-700"
                      }"></i>
                      <h3 class="font-bold text-lg ${
                        isCompleted ? "text-white" : "text-gray-800"
                      }">${tienda.name}</h3>
                    </div>
                    
                    <p class="text-sm ${
                      isCompleted ? "text-gray-100" : "text-gray-600"
                    } mb-3 flex items-start">
                      <i class="fas fa-map-marker-alt mt-1 mr-2 flex-shrink-0"></i>
                      ${tienda.address}
                    </p>
                    
                    <div class="flex items-center justify-between">
                      <div class="text-xs ${
                        isCompleted ? "text-gray-200" : "text-gray-500"
                      } flex items-center">
                        <i class="fas fa-calendar-alt mr-1"></i>
                        Cada ${tienda.visitFrequency} d√≠a${
                tienda.visitFrequency > 1 ? "s" : ""
              }
                      </div>
                      ${actionButton}
                    </div>
                  </div>
                </div>
              </div>
            `;
            })
            .join("");
        } catch (error) {
          hideLoader();
          console.error("Error al cargar tiendas:", error);
          const container = document.getElementById("tiendasContainer");
          container.innerHTML = `
            <div class="bg-white rounded-lg p-6 text-center">
              <i class="fas fa-exclamation-triangle text-red-400 text-3xl mb-3"></i>
              <p class="text-gray-600">Error al cargar tiendas asignadas</p>
              <button onclick="cargarTiendasAsignadas()" class="mt-3 text-gray-700 hover:text-gray-900">
                <i class="fas fa-redo mr-1"></i>Reintentar
              </button>
            </div>
          `;
        }
      }

      function visitarTienda(tiendaId) {
        // Guardar ID de tienda a visitar en sessionStorage
        sessionStorage.setItem("tiendaAVisitar", tiendaId);

        // Redirigir a p√°gina de escaneo QR
        window.location.href = "./qr-scanner.html";
      }

      function completarRuta() {
        document
          .getElementById("modalCompletarRuta")
          .classList.remove("hidden");
      }

      function cerrarModalRuta() {
        document.getElementById("modalCompletarRuta").classList.add("hidden");
      }

      // ===== ACTUALIZACI√ìN AUTOM√ÅTICA DE TIENDAS =====
      let updateInterval = null;
      let lastStoresCount = 0;

      /**
       * Inicia el polling para verificar nuevas tiendas
       */
      function iniciarActualizacionAutomatica() {
        // Verificar cada 30 segundos si hay nuevas tiendas
        const INTERVALO_ACTUALIZACION = 30000; // 30 segundos

        console.log("üîÑ Iniciando actualizaci√≥n autom√°tica de tiendas...");

        updateInterval = setInterval(async () => {
          // Solo verificar si hay conexi√≥n
          const isOnline =
            typeof offlineManager !== "undefined" && offlineManager
              ? offlineManager.checkOnlineStatus()
              : navigator.onLine;

          if (!isOnline) {
            console.log("üì¥ Sin conexi√≥n - omitiendo verificaci√≥n de tiendas");
            return;
          }

          try {
            console.log("üîç Verificando actualizaciones de tiendas...");

            const response = await apiFetch(
              API_CONFIG.ENDPOINTS.STORES_COURIER,
              {
                method: "GET",
              }
            );

            if (response.ok) {
              const result = await response.json();
              const tiendas = result.data || result;

              // Verificar si hay cambios en la cantidad de tiendas
              if (tiendas.length !== lastStoresCount) {
                console.log(
                  `üì¢ Cambio detectado: ${lastStoresCount} ‚Üí ${tiendas.length} tiendas`
                );

                // Actualizar contador
                lastStoresCount = tiendas.length;

                // Mostrar notificaci√≥n si hay m√°s tiendas
                if (tiendas.length > lastStoresCount - tiendas.length) {
                  showNotification(
                    `Se ${
                      tiendas.length - (lastStoresCount - tiendas.length) === 1
                        ? "ha agregado una nueva tienda"
                        : "han agregado nuevas tiendas"
                    }`,
                    "info"
                  );
                }

                // Recargar tiendas autom√°ticamente
                await cargarTiendasAsignadas();
                console.log("‚úÖ Tiendas actualizadas autom√°ticamente");
              } else {
                console.log("‚úì No hay cambios en las tiendas");
              }
            }
          } catch (error) {
            console.error("‚ùå Error al verificar actualizaciones:", error);
          }
        }, INTERVALO_ACTUALIZACION);

        console.log(
          `‚úÖ Actualizaci√≥n autom√°tica configurada (cada ${
            INTERVALO_ACTUALIZACION / 1000
          }s)`
        );
      }

      /**
       * Detiene el polling de actualizaci√≥n
       */
      function detenerActualizacionAutomatica() {
        if (updateInterval) {
          clearInterval(updateInterval);
          updateInterval = null;
          console.log("‚èπÔ∏è Actualizaci√≥n autom√°tica detenida");
        }
      }

      // Detener actualizaci√≥n cuando la p√°gina se oculta (ahorro de recursos)
      document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
          detenerActualizacionAutomatica();
        } else {
          // Reanudar cuando vuelve a ser visible
          iniciarActualizacionAutomatica();
          // Verificar inmediatamente
          cargarTiendasAsignadas();
        }
      });

      // Inicializar cuando la p√°gina carga
      document.addEventListener("DOMContentLoaded", async () => {
        await initDashboard();

        // Iniciar actualizaci√≥n autom√°tica despu√©s de cargar el dashboard
        iniciarActualizacionAutomatica();
      });
    </script>
  </body>
</html>
